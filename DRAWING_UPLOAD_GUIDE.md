# Руководство по загрузке чертежей в мастер создания заказа

## Обзор функциональности

В мастер создания заказа добавлена возможность загрузки чертежей и документов на 2-м шаге "Заказ". Пользователи могут загружать файлы различных форматов, которые будут автоматически прикреплены к заказу после его создания.

## Поддерживаемые форматы файлов

- **PDF** (.pdf) - документы и чертежи
- **AutoCAD** (.dwg, .dxf) - чертежи САПР
- **Изображения** (.jpg, .jpeg, .png, .tiff, .bmp) - фотографии и сканы

## Ограничения

- **Максимальный размер файла**: 10MB
- **Максимальное количество файлов**: 10
- **Общий размер**: не ограничен (кроме ограничений сервера)

## Как использовать

### 1. Создание заказа

1. Перейдите в раздел "Заказы" → "Создать заказ"
2. Заполните информацию о клиенте (шаг 1)
3. На шаге 2 "Заказ" найдите блок "Чертежи и документы"

### 2. Загрузка файлов

#### Способ 1: Перетаскивание
- Перетащите файлы в область загрузки
- Файлы будут автоматически проверены и добавлены

#### Способ 2: Выбор файлов
- Нажмите на область загрузки или кнопку "выберите файлы"
- Выберите нужные файлы в диалоговом окне

### 3. Управление файлами

После загрузки файлы отображаются в списке с возможностью:
- **Просмотр** - открыть файл в новой вкладке
- **Скачивание** - скачать файл на компьютер
- **Удаление** - удалить файл из списка

### 4. Создание заказа

После заполнения всех шагов нажмите "Создать заказ". Система:
1. Создаст заказ
2. Автоматически загрузит все прикрепленные чертежи
3. Покажет статус загрузки в кнопке

## Технические детали

### Компоненты

- **DrawingUpload** (`/client/src/components/UI/DrawingUpload.js`) - основной компонент загрузки
- **CreateOrderWizard** - интегрирован в мастер создания заказа

### API эндпоинты

- `POST /api/orders/:id/drawings` - загрузка чертежа
- `GET /api/orders/:id/drawings` - получение списка чертежей
- `GET /api/orders/:id/drawings/:drawingId` - скачивание чертежа
- `DELETE /api/orders/:id/drawings/:drawingId` - удаление чертежа

### База данных

Чертежи сохраняются в таблице `order_drawings`:
- `order_id` - ID заказа
- `file_name` - имя файла
- `file_data` - содержимое файла (BLOB)
- `file_type` - MIME тип
- `file_size` - размер в байтах
- `uploaded_by` - ID пользователя

## Валидация

### Проверки на клиенте
- Формат файла (по расширению)
- Размер файла (максимум 10MB)
- Количество файлов (максимум 10)

### Проверки на сервере
- Аутентификация пользователя
- Существование заказа
- Валидация MIME типа
- Проверка размера файла

## Обработка ошибок

- **Неподдерживаемый формат**: показывается сообщение с поддерживаемыми форматами
- **Превышение размера**: показывается максимально допустимый размер
- **Ошибка загрузки**: показывается общее сообщение об ошибке
- **Ошибка сети**: автоматическая повторная попытка не предусмотрена

## Безопасность

- Все загрузки требуют аутентификации
- Файлы сохраняются в базе данных (не в файловой системе)
- Проверка MIME типа на сервере
- Ограничения по размеру и количеству файлов

## Тестирование

Для тестирования функциональности используйте файл `test_drawing_upload.html`:
1. Откройте файл в браузере
2. Загрузите тестовые файлы
3. Нажмите "Тест загрузки на сервер"
4. Проверьте консоль браузера для деталей

## Будущие улучшения

- [ ] Предварительный просмотр изображений
- [ ] Сжатие изображений перед загрузкой
- [ ] Прогресс-бар для загрузки
- [ ] Пакетная загрузка файлов
- [ ] Интеграция с облачными хранилищами
- [ ] Версионирование чертежей

















