# Интеграция канбан-доски с CRM

## Обзор

Канбан-доска интегрирована с системой CRM для автоматического управления заказами в производстве. Заказы попадают на канбан когда их статус меняется на "В производство" и проходят через этапы производства.

## Этапы производства

Канбан-доска состоит из следующих колонок (этапов производства):

1. **КБ** - Конструкторское бюро
2. **Столярный цех** - Изготовление деревянных элементов
3. **Формовка ППУ** - Формовка пенополиуретана
4. **Швейный цех** - Пошив обивки
5. **Сборка и упаковка** - Финальная сборка
6. **Готов к отгрузке** - Заказ готов к отправке
7. **Отгружен** - Заказ отправлен клиенту

## Логика работы

### 1. Попадание заказов на канбан

- Заказы создаются в калькуляторе со статусом **"Черновик"**
- На странице заказов менеджер может изменить статус на **"Закупка"** или **"В производство"**
- Как только статус меняется на **"В производство"**, заказ автоматически попадает на канбан-доску
- Заказ размещается в колонке **"КБ"** (первый этап производства)

### 2. Перемещение по этапам

- Заказы можно перетаскивать между колонками (drag & drop)
- При перемещении автоматически обновляется этап производства в базе данных
- Когда заказ попадает в колонку **"Отгружен"**, его статус в CRM меняется на **"Отправлен"**

### 3. Отображение информации

Каждая карточка заказа показывает:
- Номер заказа (#12345)
- Имя клиента
- Сумма заказа
- Приоритет (Срочно/Высокий/Обычный/Низкий)
- Срок выполнения
- Статус просрочки (если применимо)

## API Endpoints

### Получение данных канбана
```
GET /api/orders/kanban
```
Возвращает все заказы в производстве, сгруппированные по этапам.

### Обновление этапа производства
```
PUT /api/orders/kanban/:orderId/stage
Body: { "stage": "Столярный цех" }
```
Обновляет этап производства заказа.

## База данных

### Таблица production_operations
Добавлено поле `production_stage` для отслеживания текущего этапа производства:

```sql
ALTER TABLE production_operations 
ADD COLUMN production_stage VARCHAR(50) DEFAULT 'КБ';
```

### Синхронизация статусов
- При изменении этапа на "Отгружен" статус заказа автоматически меняется на "shipped"
- Все изменения записываются в `order_status_history`

## Настройка

### 1. Миграция базы данных
```bash
cd server
node scripts/migrate.js
```

### 2. Запуск сервера
```bash
cd server
npm start
```

### 3. Запуск клиента
```bash
cd client
npm start
```

## Автоматическое обновление

- Канбан обновляется каждые 30 секунд
- Изменения сохраняются в реальном времени при drag & drop
- При ошибке обновления показывается уведомление пользователю

## Приоритеты заказов

- **Срочно** - красный цвет
- **Высокий** - оранжевый цвет  
- **Обычный** - синий цвет
- **Низкий** - серый цвет

## Функции канбана

- ✅ Горизонтальная прокрутка с индикаторами
- ✅ Drag & drop между колонками
- ✅ Автоматическая синхронизация с CRM
- ✅ Отображение приоритетов и статусов
- ✅ Детальный просмотр заказов
- ✅ Мобильная адаптация

## Интеграция с калькулятором

Заказы из калькулятора автоматически попадают в CRM со статусом "Черновик". После подтверждения менеджером и изменения статуса на "В производство" они появляются на канбан-доске.
















