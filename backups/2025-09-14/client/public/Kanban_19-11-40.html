<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sofany Pro CRM - Канбан</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
    :root {
        --primary: #0ea5a5;
        --primary-dark: #0b8f8f;
        --primary-light: #e0f7f7;
        --success: #10b981;
        --success-light: #d1fae5;
        --warning: #f59e0b;
        --warning-light: #fef3c7;
        --error: #ef4444;
        --error-light: #fee2e2;
        --text: #0f172a;
        --text-muted: #64748b;
        --bg: #f8fafc;
        --card-bg: #ffffff;
        --border: #e2e8f0;
        --border-light: #f1f5f9;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --golden-ratio: 61.8%;
    }

    .dark-theme {
        --primary: #0ea5a5;
        --primary-dark: #0b8f8f;
        --primary-light: #1a3e3e;
        --text: #e2e8f0;
        --text-muted: #94a3b8;
        --bg: #0f172a;
        --card-bg: #1e293b;
        --border: #334155;
        --border-light: #1e293b;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
        --shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Inter', sans-serif;
    }

    body {
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        padding: 1.5rem;
        position: relative;
        overflow-x: hidden;
        transition: background 0.3s, color 0.3s;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .logo {
        font-size: 1.8rem;
        font-weight: 800;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .theme-toggle {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 2rem;
        padding: 0.5rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s;
        color: var(--text);
    }

    .theme-toggle:hover {
        box-shadow: var(--shadow);
    }

    .theme-icon {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Канбан доска */
    .kanban-board {
        display: flex;
        gap: 1.5rem;
        padding-bottom: 1rem;
        overflow-x: hidden;
        transition: overflow-x 0.3s;
    }

    .kanban-board:hover {
        overflow-x: auto;
    }

    .kanban-column {
        min-width: 320px;
        background: var(--card-bg);
        border-radius: 0.75rem;
        padding: 1.25rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-light);
    }

    .column-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.25rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border);
    }

    .column-title {
        font-size: 1.125rem;
        font-weight: 600;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding: 0.5rem;
        border-radius: 0.375rem;
        transition: all 0.2s;
    }

    .column-title:hover {
        background: var(--bg);
    }

    .column-sum {
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--primary);
        background: var(--primary-light);
        padding: 0.25rem 0.5rem;
        border-radius: 0.5rem;
        display: inline-block;
        width: fit-content;
    }

    .column-title-input {
        font-size: 1.125rem;
        font-weight: 600;
        border: 1px solid var(--primary);
        border-radius: 0.375rem;
        padding: 0.5rem;
        width: 100%;
    }

    .column-count {
        background: var(--primary-light);
        color: var(--primary);
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.25rem 0.5rem;
        border-radius: 1rem;
    }

    .column-actions {
        display: flex;
        gap: 0.5rem;
    }

    .column-action {
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.2s;
        padding: 0.25rem;
        border-radius: 0.25rem;
    }

    .column-action:hover {
        color: var(--primary);
        background: var(--primary-light);
    }

    .column-delete {
        color: var(--error) !important;
    }

    .column-delete:hover {
        color: white !important;
        background: var(--error) !important;
        transform: scale(1.05);
    }

    /* Скрываем кнопку удаления для системных колонок */
    .kanban-column[data-column-id="1"] .column-delete,
    .kanban-column[data-column-id="2"] .column-delete,
    .kanban-column[data-column-id="3"] .column-delete,
    .kanban-column[data-column-id="4"] .column-delete,
    .kanban-column[data-column-id="5"] .column-delete,
    .kanban-column[data-column-id="6"] .column-delete,
    .kanban-column[data-column-id="7"] .column-delete {
        display: none;
    }

    /* Стили для модального окна настроек колонок */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: var(--bg);
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        border: 1px solid var(--border);
    }

    .modal-header {
        padding: 24px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text);
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6b7280;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .close-btn:hover {
        color: #374151;
    }

    .modal-body {
        padding: 24px;
    }

    .modal-footer {
        padding: 24px;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }


    /* Компактный вид карточек */
    .kanban-card.compact {
        padding: 8px 12px;
        min-height: auto;
        height: auto;
    }

    .kanban-card.compact .card-header {
        margin-bottom: 4px;
    }

    .kanban-card.compact .card-deadline {
        font-size: 0.75rem;
        padding: 2px 6px;
        height: 24px;
    }

    .kanban-card.compact .card-title {
        font-size: 0.75rem;
        margin-bottom: 2px;
        line-height: 1.2;
    }

    .kanban-card.compact .card-header-info {
        margin-bottom: 2px;
    }

    .kanban-card.compact .card-order-number {
        font-size: 0.75rem;
        padding: 2px 6px;
    }

    .kanban-card.compact .production-marker-circle {
        width: 14px;
        height: 14px;
        font-size: 0.625rem;
    }

    .kanban-card.compact .deadline {
        font-size: 0.75rem;
        padding: 2px 6px;
        border-radius: 4px;
        height: 24px;
    }

    .kanban-card.compact .prepayment {
        font-size: 0.625rem;
        padding: 1px 4px;
    }

    .kanban-card.compact .card-dates {
        display: none;
    }

    .kanban-card.compact .production-marker {
        display: none;
    }

    .kanban-card.compact .card-footer {
        display: none;
    }


    .kanban-card.compact .card-amount {
        font-size: 0.875rem;
        font-weight: 600;
    }



    /* Скрываем элементы в компактном режиме */
    .compact-view .kanban-card:not(.compact) {
        display: none;
    }

    .compact-view .kanban-card.compact {
        display: block;
    }

    /* Карточки */
    .kanban-cards {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        min-height: 100px;
    }

    .kanban-card {
        background: var(--card-bg);
        border-radius: 0.5rem;
        padding: 1.25rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-light);
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }

    .kanban-card:hover {
        box-shadow: var(--shadow-hover);
        transform: translateY(-2px);
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        gap: 0.5rem;
    }

    .card-deadline {
        font-weight: 600;
        color: #fff;
        background: var(--warning);
        padding: 4px 8px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        font-size: 0.875rem;
        white-space: nowrap;
        height: 28px;
        box-sizing: border-box;
    }

    .card-amount {
        background: var(--success);
        color: white;
        font-size: 0.875rem;
        font-weight: 600;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
    }



    .card-title {
        font-weight: 600;
        margin-bottom: 0.75rem;
        line-height: 1.4;
        font-size: 1rem;
    }

    .card-details {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.75rem;
    }

    .card-deadline-section {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }

    .deadline-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-bottom: 0.25rem;
    }

    .deadline-date {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-primary);
    }

    .card-prepayment-section {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }

    .prepayment-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-bottom: 0.25rem;
    }

    .prepayment-amount {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--success);
    }

    .card-header-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        gap: 0.5rem;
    }

    .right-info {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.25rem;
    }

    .card-order-number {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .qr-button {
        background: none;
        border: none;
        cursor: pointer;
        color: var(--primary);
        padding: 2px;
        border-radius: 4px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .qr-button:hover {
        background: var(--primary-light);
        color: var(--primary-dark);
    }

    .card-qr-section {
        margin: 10px 0;
        padding: 8px;
        background: var(--bg);
        border-radius: 6px;
        border: 1px solid var(--border);
    }

    .qr-code-display {
        text-align: center;
        margin-bottom: 8px;
    }

    .qr-image {
        width: 50px;
        height: 50px;
        border: 1px solid var(--border);
        border-radius: 4px;
        display: block;
        margin: 0 auto;
    }
    
    .order-number-frame {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 4px 8px;
        font-family: 'Courier New', monospace;
        font-weight: bold;
        font-size: 0.75rem;
        color: var(--text);
        min-width: 40px;
        text-align: center;
    }
    
    .status-circle {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.7rem;
        color: white;
        flex-shrink: 0;
    }
    
    .status-circle.priority-high {
        background: #ef4444; /* Красный */
    }
    
    .status-circle.priority-medium,
    .status-circle.priority-normal {
        background: #fbbf24; /* Желтый */
    }
    
    .status-circle.priority-low {
        background: #10b981; /* Зеленый */
    }

    .production-marker-circle {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        color: white;
        font-size: 0.75rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .production-marker-circle.priority-high {
        background: var(--error);
    }

    .production-marker-circle.priority-medium {
        background: var(--warning);
    }

    .production-marker-circle.priority-low {
        background: var(--success);
    }

    /* Стили для кнопки "В пошиве" */
    .sewing-status-button {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        width: 100%;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: #f9fafb;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: left;
    }

    .sewing-status-button:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
    }

    .sewing-status-button.active {
        background: #ecfdf5;
        border-color: #10b981;
    }

    .sewing-icon {
        flex-shrink: 0;
        color: #6b7280;
        transition: color 0.2s ease;
    }

    .sewing-status-button.active .sewing-icon {
        color: #10b981;
    }

    .sewing-content {
        flex: 1;
    }

    .sewing-title {
        font-weight: 500;
        color: #374151;
        margin-bottom: 2px;
        transition: color 0.2s ease;
    }

    .sewing-status-button.active .sewing-title {
        color: #065f46;
    }

    .sewing-description {
        font-size: 12px;
        color: #6b7280;
        transition: color 0.2s ease;
    }

    .sewing-status-button.active .sewing-description {
        color: #047857;
    }

    .card-dates {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        color: var(--text-muted);
        font-size: 0.875rem;
        margin-bottom: 1rem;
    }

    .card-dates span {
        display: flex;
        justify-content: space-between;
    }

    .prepayment {
        font-weight: 600;
        color: var(--success);
        font-size: 0.75rem;
        background: rgba(40, 167, 69, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
        border: 1px solid rgba(40, 167, 69, 0.3);
        white-space: nowrap;
    }

    .deadline {
        font-weight: 600;
        color: #fff;
        background: var(--warning);
        padding: 4px 8px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        font-size: 0.875rem;
        flex-shrink: 0;
        white-space: nowrap;
        height: 28px;
        box-sizing: border-box;
    }

    .card-footer {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 0.25rem;
    }


    /* Маркер производства */
    .production-marker {
        background-color: #3b82f6;
        color: white;
        font-size: 0.75rem;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 4px;
        text-align: center;
        margin: 8px 0;
        display: none; /* По умолчанию скрыт */
    }

    .production-status {
        background: #2563eb;
        color: white;
        font-size: 0.55rem;
        font-weight: 600;
        padding: 0.15rem 0.3rem;
        border-radius: 0.4rem;
        width: fit-content;
        margin: 0.125rem 0;
        display: none; /* По умолчанию скрыт */
        transition: all 0.2s ease;
    }


    /* Стили для тумблера */
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .toggle-slider {
        background-color: #3b82f6;
    }

    input:checked + .toggle-slider:before {
        transform: translateX(26px);
    }

    .client-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        font-weight: 600;
        flex-shrink: 0;
    }

    .client-name {
        font-weight: 500;
        font-size: 0.9rem;
    }
    
    
    .card-address {
        font-size: 11px;
        color: #666;
        margin-top: 6px;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .card-contact {
        font-size: 11px;
        color: #666;
        margin-top: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    /* Форма добавления карточки */
    .add-card-form {
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 0.5rem;
        background: var(--bg);
        border: 1px dashed var(--border);
    }

    .form-group {
        margin-bottom: 0.75rem;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border);
        border-radius: 0.375rem;
        font-size: 1rem;
        background: var(--card-bg);
        color: var(--text);
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-light);
    }

    .form-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
    }

    /* Кнопки */
    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 0.375rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        line-height: 1.25rem;
    }

    .btn-primary {
        background-color: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        background-color: var(--primary-dark);
    }

    .btn-secondary {
        background-color: var(--bg);
        color: var(--text);
        border: 1px solid var(--border);
    }

    .btn-secondary:hover {
        background-color: var(--border);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-secondary:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .btn-secondary.active {
        background-color: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .btn-secondary.active:hover {
        background-color: var(--primary-dark);
        border-color: var(--primary-dark);
    }

    /* Стили для перетаскивания */
    .kanban-card.dragging {
        opacity: 0.5;
        transform: rotate(5deg);
    }

    .kanban-column.drop-area {
        background-color: var(--primary-light);
        border: 2px dashed var(--primary);
    }

    /* Правая панель */
    .detail-panel {
        position: fixed;
        top: 0;
        right: 0;
        width: 61.8%; /* Золотое сечение */
        max-width: 650px;
        min-width: 450px;
        height: 100vh;
        background: var(--card-bg);
        box-shadow: -5px 0 25px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 1.5rem;
        transform: translateX(100%);
        opacity: 0;
        visibility: hidden;
        transition: transform 0.3s ease, opacity 0.3s ease, visibility 0.3s;
        border-radius: 0.75rem 0 0 0.75rem; /* Скругление только с левой стороны */
        box-sizing: border-box;
        contain: layout style;
    }

    .detail-panel.active {
        transform: translateX(0);
        opacity: 1;
        visibility: visible;
    }

    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border);
    }

    .panel-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text);
    }

    .panel-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .close-panel, .add-column-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-muted);
        transition: all 0.2s;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }

    .close-panel:hover, .add-column-btn:hover {
        color: var(--error);
        background: var(--error-light);
    }

    .client-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .client-details h3 {
        font-size: 1.25rem;
        margin-bottom: 0.25rem;
    }

    .client-details p {
        color: var(--text-muted);
    }

    /* Стили для кнопки перехода на страницу заказа */
    .order-page-link-section {
        padding: 1.5rem;
        border-top: 1px solid var(--border);
        background: var(--bg);
        margin-top: auto;
    }

    .order-page-btn {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
        font-weight: 500;
        border-radius: 0.5rem;
        transition: all 0.2s ease;
    }

    .order-page-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .order-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    /* Стили для объединенного блока контактов и доставки */
    .unified-contact-delivery-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: var(--bg);
        border-radius: 0.75rem;
        border: 1px solid var(--border-light);
        box-shadow: var(--shadow-sm);
    }

    .unified-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-top: 1rem;
    }

    .contact-column,
    .delivery-column {
        display: flex;
        flex-direction: column;
    }

    .column-header {
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--primary-100);
    }

    .column-header h4 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--primary-600);
        margin: 0;
    }

    .info-grid {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .info-field {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .info-field label {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-muted);
        margin: 0;
    }

    .info-field .field-content {
        position: relative;
    }

    .info-field .info-value {
        display: block;
        padding: 0.75rem;
        background: var(--gray-50);
        border: 1px solid var(--border-light);
        border-radius: 0.5rem;
        font-size: 0.875rem;
        color: var(--text);
        min-height: 2.5rem;
        line-height: 1.4;
    }

    .info-field .field-input,
    .info-field .field-textarea,
    .info-field .field-select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        font-size: 0.875rem;
        color: var(--text);
        background: var(--bg);
        transition: all 0.2s ease;
    }

    .info-field .field-input:focus,
    .info-field .field-textarea:focus,
    .info-field .field-select:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px var(--primary-100);
    }

    .info-field .field-textarea {
        min-height: 4rem;
        resize: vertical;
    }

    /* Адаптивность для объединенного блока */
    @media (max-width: 768px) {
        .unified-content {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
    }

    /* Стили для empty-state */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 3rem 2rem;
        text-align: center;
        color: var(--text-muted);
    }

    .empty-icon {
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-state h3 {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        font-size: 0.875rem;
        line-height: 1.5;
        max-width: 400px;
    }

    .detail-item {
        padding: 1rem;
        background: var(--bg);
        border-radius: 0.5rem;
    }

    .detail-item label {
        display: block;
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
    }

    .detail-item .value {
        font-weight: 600;
        font-size: 1rem;
    }

    .select-status {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border);
        border-radius: 0.375rem;
        background: var(--card-bg);
        font-weight: 500;
        color: var(--text);
    }

    .panel-tabs {
        display: flex;
        border-bottom: 1px solid var(--border);
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        position: relative;
        z-index: 2;
        background: var(--card-bg);
    }

    .tab {
        padding: 0.75rem 1.5rem;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
        font-weight: 500;
    }

    .tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
    }

    .tab-content {
        display: none;
        position: relative;
        z-index: 1;
    }

    .tab-content.active {
        display: block;
        position: relative;
        z-index: 1;
    }

    /* Секции в табах */
    .project-description-section,
    .drawings-section,
    .comments-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: var(--bg);
        border-radius: 0.75rem;
        border: 1px solid var(--border-light);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border);
    }

    .section-header h3 {
        margin: 0;
        color: var(--text);
        font-size: 1.125rem;
        font-weight: 600;
    }

    .edit-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background: transparent;
        color: var(--text);
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .add-file-btn,
    .add-comment-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .edit-btn:hover {
        background: var(--gray-100);
        transform: translateY(-1px);
    }

    .add-file-btn:hover,
    .add-comment-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
    }

    /* Поля описания проекта */
    .description-field {
        margin-bottom: 1.5rem;
    }

    .description-field label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text);
        font-size: 0.875rem;
    }

    .field-content {
        position: relative;
    }

    .field-value {
        display: block;
        padding: 0.75rem;
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        color: var(--text);
        min-height: 2.5rem;
        line-height: 1.5;
    }

    .field-input,
    .field-textarea,
    .field-select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--primary);
        border-radius: 0.5rem;
        background: var(--card-bg);
        color: var(--text);
        font-family: inherit;
        font-size: 0.875rem;
        resize: vertical;
    }

    .field-textarea {
        min-height: 4rem;
    }

    .description-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border);
    }

    /* Файлы */
    .files-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .file-download {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        transition: all 0.2s ease;
    }

    .file-download:hover {
        border-color: var(--primary);
        box-shadow: 0 2px 8px rgba(14, 165, 165, 0.1);
    }

    .file-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex: 1;
    }

    .file-icon {
        color: var(--primary);
        flex-shrink: 0;
    }

    .file-name {
        font-weight: 500;
        color: var(--text);
        margin-bottom: 0.25rem;
    }

    .file-size {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .file-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .download-btn {
        padding: 0.5rem 1rem;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.75rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .download-btn:hover {
        background: var(--primary-dark);
    }

    .delete-btn {
        width: 2rem;
        height: 2rem;
        background: var(--error);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .delete-btn:hover {
        background: #dc2626;
        transform: scale(1.1);
    }

    .comment {
        padding: 1rem;
        background: var(--card-bg);
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        border: 1px solid var(--border-light);
    }

    /* Финансовый блок */
    .finance-section,
    .payments-history-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: var(--bg);
        border-radius: 0.75rem;
        border: 1px solid var(--border-light);
    }

    .finance-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1.5rem;
        background: var(--card-bg);
        border-radius: 0.75rem;
        border: 1px solid var(--border);
        transition: all 0.2s ease;
    }

    .stat-card:hover {
        border-color: var(--primary);
        box-shadow: 0 4px 12px rgba(14, 165, 165, 0.1);
    }

    .stat-icon {
        color: var(--primary);
        flex-shrink: 0;
    }

    .stat-content {
        flex: 1;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 0.25rem;
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--text-muted);
        font-weight: 500;
    }

    .finance-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .detail-field {
        display: flex;
        flex-direction: column;
    }

    .detail-field label {
        font-weight: 500;
        color: var(--text);
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }

    .field-select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--primary);
        border-radius: 0.5rem;
        background: var(--card-bg);
        color: var(--text);
        font-family: inherit;
        font-size: 0.875rem;
    }

    .finance-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border);
    }

    /* История платежей */
    .payments-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .payment-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        transition: all 0.2s ease;
    }

    .payment-item:hover {
        border-color: var(--primary);
        box-shadow: 0 2px 8px rgba(14, 165, 165, 0.1);
    }

    .payment-info {
        flex: 1;
    }

    .payment-amount {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 0.25rem;
    }

    .payment-type {
        font-size: 0.875rem;
        color: var(--text-muted);
    }

    .payment-details {
        flex: 1;
        text-align: center;
    }

    .payment-date {
        font-size: 0.875rem;
        color: var(--text);
        margin-bottom: 0.25rem;
    }

    .payment-method {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .payment-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .edit-payment-btn,
    .delete-payment-btn {
        width: 2rem;
        height: 2rem;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }
    
    .edit-payment-btn svg,
    .delete-payment-btn svg {
        width: 14px;
        height: 14px;
    }

    .edit-payment-btn {
        background: var(--warning-light);
        color: var(--warning);
    }

    .edit-payment-btn:hover {
        background: var(--warning);
        color: white;
    }

    .delete-payment-btn {
        background: var(--error-light);
        color: var(--error);
    }

    .delete-payment-btn:hover {
        background: var(--error);
        color: white;
    }

    /* Таблица материалов */
    .materials-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: var(--bg);
        border-radius: 0.75rem;
        border: 1px solid var(--border-light);
    }

    .materials-table-container {
        overflow-x: auto;
        border-radius: 0.5rem;
        border: 1px solid var(--border);
    }

    .materials-table {
        width: 100%;
        border-collapse: collapse;
        background: var(--card-bg);
    }

    .materials-table thead {
        background: var(--primary-light);
    }

    .materials-table th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: var(--text);
        border-bottom: 1px solid var(--border);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .materials-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--border-light);
        color: var(--text);
        font-size: 0.875rem;
    }

    .materials-table tbody tr:hover {
        background: var(--bg);
    }

    .materials-table tbody tr:last-child td {
        border-bottom: none;
    }

    .materials-table .actions-cell {
        width: 120px;
        text-align: center;
    }

    .edit-material-btn,
    .delete-material-btn {
        width: 2rem;
        height: 2rem;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin: 0 0.25rem;
        transition: all 0.2s ease;
    }
    
    .edit-material-btn svg,
    .delete-material-btn svg {
        width: 14px;
        height: 14px;
    }

    .edit-material-btn {
        background: var(--warning-light);
        color: var(--warning);
    }

    .edit-material-btn:hover {
        background: var(--warning);
        color: white;
        transform: scale(1.05);
    }

    .delete-material-btn {
        background: var(--error-light);
        color: var(--error);
    }

    .delete-material-btn:hover {
        background: var(--error);
        color: white;
        transform: scale(1.05);
    }

    .add-material-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .add-material-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
    }

    .comment-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .comment-author {
        font-weight: 600;
    }

    .comment-time {
        color: var(--text-muted);
        font-size: 0.875rem;
    }

    .comment-text {
        line-height: 1.5;
    }

    .file-download {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem;
        background: var(--bg);
        border-radius: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .file-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .file-icon {
        width: 40px;
        height: 40px;
        background: var(--primary-light);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary);
    }

    .file-name {
        font-weight: 500;
    }

    .file-size {
        font-size: 0.875rem;
        color: var(--text-muted);
    }

    .download-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.2s;
    }

    .download-btn:hover {
        background: var(--primary-dark);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-card {
        padding: 1rem;
        background: var(--bg);
        border-radius: 0.5rem;
        text-align: center;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 0.25rem;
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--text-muted);
    }

    .material-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem;
        background: var(--bg);
        border-radius: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .material-name {
        font-weight: 500;
    }

    .material-quantity {
        color: var(--text-muted);
    }

    .contacts-section,
    .delivery-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: var(--bg);
        border-radius: 0.75rem;
        border: 1px solid var(--border-light);
    }
    
    .contacts-info,
    .delivery-info {
        padding: 0;
        background: transparent;
        border-radius: 0;
        margin-bottom: 0;
    }

    .info-row {
        display: flex;
        flex-direction: column;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-light);
    }

    .info-row:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    .info-label {
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: var(--text);
        font-size: 0.875rem;
    }

    .info-value {
        color: var(--text);
        font-weight: 500;
    }
    
    .field-content {
        position: relative;
        width: 100%;
    }
    
    .field-select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--primary);
        border-radius: 0.5rem;
        background: var(--card-bg);
        color: var(--text);
        font-family: inherit;
        font-size: 0.875rem;
    }

    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
    }

    .overlay.active {
        opacity: 1;
        visibility: visible;
    }

    /* Оверлей для правой панели */
    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .overlay.active {
        opacity: 1;
        visibility: visible;
    }

    /* Адаптивность */
    @media (max-width: 1024px) {
        .detail-panel {
            width: 75%;
            max-width: 600px;
        }
    }

    @media (max-width: 768px) {
        .kanban-column {
            min-width: 280px;
        }
        
        .header {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }
        
        .detail-panel {
            width: 100%;
            min-width: unset;
            max-width: 100%;
            transform: translateX(100%);
            border-radius: 0;
            padding: 1rem;
        }
        
        .detail-panel.active {
            transform: translateX(0);
        }

        .order-details {
            grid-template-columns: 1fr;
        }
    }
    </style>
</head>
<body>
    <!-- Шапка -->
    <div class="header">
            <div class="logo">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </div>

        <button class="theme-toggle" id="theme-toggle">
            <div class="theme-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </div>
            <span>Темная тема</span>
        </button>
        
        <button class="btn btn-secondary" onclick="loadKanbanData()" style="margin-left: 1rem;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                <path d="M23 4v6h-6"></path>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
            Обновить данные
        </button>
        
        <button class="btn btn-secondary" onclick="openColumnSettings()" style="margin-left: 1rem;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
            Настройки колонок
        </button>
        
        <button class="btn btn-secondary" onclick="toggleCompactView()" style="margin-left: 1rem;" id="compact-view-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="9" y1="9" x2="15" y2="9"></line>
                <line x1="9" y1="15" x2="15" y2="15"></line>
            </svg>
            <span id="compact-view-text">Компактный вид</span>
        </button>
    </div>

    <!-- Канбан доска -->
    <div class="kanban-board" id="kanban-board">
        <!-- Колонка 1 -->
        <div class="kanban-column" data-column-id="1">
            <div class="column-header">
                <div class="column-title">
                    <span>КБ</span>
                    <span class="column-sum" id="column-sum-1">106 400 ₽</span>
                    <span class="column-count">3</span>
                </div>
                <div class="column-actions">
                    <div class="column-action" onclick="startEditingColumnTitle(this.closest('.kanban-column'))">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                    </div>
                    <div class="column-action" onclick="toggleAddCardForm(this)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"></path>
                        </svg>
                        </div>
                    <div class="column-action column-delete" onclick="deleteColumn(this.closest('.kanban-column'))">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6"></path>
                        </svg>
                        </div>
                </div>
            </div>

            <div class="kanban-cards">
                <!-- Тестовая карточка -->
                <div class="kanban-card" draggable="true" data-card-id="test-1" data-card-amount="50000" onclick="openDetailPanel(this)">
                    <div class="card-header">
                        <div class="card-amount">50 000 ₽</div>
                        <div class="card-deadline">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 3px;">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12,6 12,12 16,14"></polyline>
                            </svg>
                            31.01.2024
                    </div>
                    </div>
                    <h3 class="card-title">Тестовый заказ</h3>
                    <div class="production-status">В пошиве</div>
                    <div class="card-header-info">
                        <div class="card-order-number">
                            SOF-7200000
                    </div>
                        <div class="prepayment">25 000 ₽</div>
                </div>
                
                <!-- QR-код прямо на карточке -->
                <div class="card-qr-section">
                    <div class="qr-code-display">
                        <img src="/api/production/qr-image/1" alt="QR-код заказа SOF-7200000" class="qr-image" />
                    </div>
                </div>

                    <div class="card-footer">
                        <div class="client-avatar">ТЕ</div>
                        <div class="client-name">Тест Тестов</div>
                    </div>
                </div>


            </div>

            <div class="add-card-form" style="display: none;">
                        <div class="form-group">
                    <input type="text" class="form-input" placeholder="Название изделия">
                        </div>
                        <div class="form-group">
                    <input type="number" class="form-input" placeholder="Сумма заказа">
                        </div>
                        <div class="form-group">
                    <input type="number" class="form-input" placeholder="Предоплата">
                        </div>
                        <div class="form-group">
                    <select class="form-input">
                        <option value="high">Высокий приоритет</option>
                        <option value="medium">Средний приоритет</option>
                        <option value="low">Низкий приоритет</option>
                    </select>
                        </div>
                        <div class="form-group">
                    <input type="text" class="form-input" placeholder="Имя клиента">
                        </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="cancelAddCard(this)">Отмена</button>
                    <button class="btn btn-primary" onclick="addNewCard(this)">Добавить</button>
                    </div>
                    </div>
                </div>

        <!-- Колонка 2 -->
        <div class="kanban-column" data-column-id="2">
            <div class="column-header">
                <div class="column-title">
                    <span>Столярный цех</span>
                    <span class="column-sum" id="column-sum-2">75 100 ₽</span>
                    <span class="column-count">2</span>
                </div>
                <div class="column-actions">
                    <div class="column-action" onclick="startEditingColumnTitle(this.closest('.kanban-column'))">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                    </div>
                    <div class="column-action" onclick="toggleAddCardForm(this)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"></path>
                        </svg>
                    </div>
                    <div class="column-action column-delete" onclick="deleteColumn(this.closest('.kanban-column'))">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="kanban-cards">

                    </div>

            <div class="add-card-form" style="display: none;">
                        <div class="form-group">
                    <input type="text" class="form-input" placeholder="Название изделия">
                    </div>
                        <div class="form-group">
                    <input type="number" class="form-input" placeholder="Сумма заказа">
                        </div>
                        <div class="form-group">
                    <input type="number" class="form-input" placeholder="Предоплата">
                        </div>
                <div class="form-group">
                    <select class="form-input">
                        <option value="high">Высокий приоритет</option>
                        <option value="medium">Средний приоритет</option>
                        <option value="low">Низкий приоритет</option>
                    </select>
                    </div>
                <div class="form-group">
                    <input type="text" class="form-input" placeholder="Имя клиента">
                        </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="cancelAddCard(this)">Отмена</button>
                    <button class="btn btn-primary" onclick="addNewCard(this)">Добавить</button>
                    </div>
                    </div>
                </div>

        <!-- Колонка 3 -->
        <div class="kanban-column" data-column-id="3">
            <div class="column-header">
                <div class="column-title">
                    <span>Формовка</span>
                    <span class="column-sum" id="column-sum-3">0 ₽</span>
                    <span class="column-count">0</span>
                    </div>
                <div class="column-actions">
                    <div class="column-action" onclick="startEditingColumnTitle(this.closest('.kanban-column'))">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </div>
                    <div class="column-action" onclick="toggleAddCardForm(this)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"></path>
                        </svg>
                    </div>
                    <div class="column-action column-delete" onclick="deleteColumn(this.closest('.kanban-column'))">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="kanban-cards">
                <!-- Карточки будут загружаться динамически -->
            </div>

            <div class="add-card-form" style="display: none;">
                        <div class="form-group">
                    <input type="text" class="form-input" placeholder="Название изделия">
                        </div>
                        <div class="form-group">
                    <input type="number" class="form-input" placeholder="Сумма заказа">
                        </div>
                        <div class="form-group">
                    <select class="form-input">
                        <option value="high">Высокий приоритет</option>
                        <option value="medium">Средний приоритет</option>
                        <option value="low">Низкий приоритет</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="text" class="form-input" placeholder="Имя клиента">
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="cancelAddCard(this)">Отмена</button>
                    <button class="btn btn-primary" onclick="addNewCard(this)">Добавить</button>
                </div>
            </div>
        </div>

        <!-- Колонка 4 -->
        <div class="kanban-column" data-column-id="4">
            <div class="column-header">
                <div class="column-title">
                    <span>Швейный цех</span>
                    <span class="column-sum" id="column-sum-4">0 ₽</span>
                    <span class="column-count">0</span>
                </div>
                <div class="column-actions">
                    <div class="column-action" onclick="startEditingColumnTitle(this.closest('.kanban-column'))">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </div>
                    <div class="column-action" onclick="toggleAddCardForm(this)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"></path>
                        </svg>
                    </div>
                    <div class="column-action column-delete" onclick="deleteColumn(this.closest('.kanban-column'))">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="kanban-cards">
                <!-- Карточки будут загружаться динамически -->
            </div>
            
            <div class="add-card-form" style="display: none;">
                <div class="form-group">
                    <input type="text" class="form-input" placeholder="Название изделия">
                </div>
                <div class="form-group">
                    <input type="number" class="form-input" placeholder="Сумма заказа">
                        </div>
                <div class="form-group">
                    <select class="form-input">
                        <option value="high">Высокий приоритет</option>
                        <option value="medium">Средний приоритет</option>
                        <option value="low">Низкий приоритет</option>
                    </select>
                    </div>
                <div class="form-group">
                    <input type="text" class="form-input" placeholder="Имя клиента">
                        </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="cancelAddCard(this)">Отмена</button>
                    <button class="btn btn-primary" onclick="addNewCard(this)">Добавить</button>
                    </div>
                    </div>
                </div>

        <!-- Колонка 5 -->
        <div class="kanban-column" data-column-id="5">
            <div class="column-header">
                <div class="column-title">
                    <span>Обивка</span>
                    <span class="column-sum" id="column-sum-5">0 ₽</span>
                    <span class="column-count">0</span>
                </div>
                <div class="column-actions">
                    <div class="column-action" onclick="startEditingColumnTitle(this.closest('.kanban-column'))">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                    </div>
                    <div class="column-action" onclick="toggleAddCardForm(this)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"></path>
                        </svg>
                    </div>
                    <div class="column-action column-delete" onclick="deleteColumn(this.closest('.kanban-column'))">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="kanban-cards">
                <!-- Карточки будут загружаться динамически -->
                    </div>
            
            <div class="add-card-form" style="display: none;">
                <div class="form-group">
                    <input type="text" class="form-input" placeholder="Название изделия">
                    </div>
                <div class="form-group">
                    <input type="number" class="form-input" placeholder="Сумма заказа">
                    </div>
                <div class="form-group">
                    <select class="form-input">
                        <option value="high">Высокий приоритет</option>
                        <option value="medium">Средний приоритет</option>
                        <option value="low">Низкий приоритет</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="text" class="form-input" placeholder="Имя клиента">
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="cancelAddCard(this)">Отмена</button>
                    <button class="btn btn-primary" onclick="addNewCard(this)">Добавить</button>
                </div>
            </div>
        </div>

        <!-- Колонка 6 -->
        <div class="kanban-column" data-column-id="6">
            <div class="column-header">
                <div class="column-title">
                    <span>Сборка и упаковка</span>
                    <span class="column-sum" id="column-sum-6">0 ₽</span>
                    <span class="column-count">0</span>
                </div>
                <div class="column-actions">
                    <div class="column-action" onclick="startEditingColumnTitle(this.closest('.kanban-column'))">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </div>
                    <div class="column-action" onclick="toggleAddCardForm(this)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"></path>
                        </svg>
                    </div>
                    <div class="column-action column-delete" onclick="deleteColumn(this.closest('.kanban-column'))">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="kanban-cards">
                <!-- Карточки будут загружаться динамически -->
                    </div>
                    
            <div class="add-card-form" style="display: none;">
                        <div class="form-group">
                    <input type="text" class="form-input" placeholder="Название изделия">
                        </div>
                        <div class="form-group">
                    <input type="number" class="form-input" placeholder="Сумма заказа">
                        </div>
                        <div class="form-group">
                    <select class="form-input">
                        <option value="high">Высокий приоритет</option>
                        <option value="medium">Средний приоритет</option>
                        <option value="low">Низкий приоритет</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="text" class="form-input" placeholder="Имя клиента">
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="cancelAddCard(this)">Отмена</button>
                    <button class="btn btn-primary" onclick="addNewCard(this)">Добавить</button>
                </div>
            </div>
        </div>

        <!-- Колонка 7 -->
        <div class="kanban-column" data-column-id="7">
            <div class="column-header">
                <div class="column-title">
                    <span>Отгружен</span>
                    <span class="column-sum" id="column-sum-7">0 ₽</span>
                    <span class="column-count">0</span>
                </div>
                <div class="column-actions">
                    <div class="column-action" onclick="startEditingColumnTitle(this.closest('.kanban-column'))">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </div>
                    <div class="column-action" onclick="toggleAddCardForm(this)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"></path>
                        </svg>
                    </div>
                    <div class="column-action column-delete" onclick="deleteColumn(this.closest('.kanban-column'))">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="kanban-cards">
                <!-- Карточки будут загружаться динамически -->
            </div>
            
            <div class="add-card-form" style="display: none;">
                <div class="form-group">
                    <input type="text" class="form-input" placeholder="Название изделия">
                </div>
                <div class="form-group">
                    <input type="number" class="form-input" placeholder="Сумма заказа">
                </div>
                <div class="form-group">
                    <select class="form-input">
                        <option value="high">Высокий приоритет</option>
                        <option value="medium">Средний приоритет</option>
                        <option value="low">Низкий приоритет</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="text" class="form-input" placeholder="Имя клиента">
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="cancelAddCard(this)">Отмена</button>
                    <button class="btn btn-primary" onclick="addNewCard(this)">Добавить</button>
                </div>
            </div>
                        </div>

                    </div>

    <!-- Оверлей -->
    <div class="overlay" id="overlay" onclick="closeDetailPanel()"></div>

    <!-- Правая панель деталей -->
    <div class="detail-panel" id="detail-panel">
        <div class="panel-header">
            <h2 class="panel-title">Детали заказа</h2>
            <div class="panel-actions">
                <button class="edit-btn" onclick="toggleEditMode('main-info')" style="margin-right: 8px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </button>
                <button onclick="savePriority()" class="btn btn-sm btn-primary" style="display: none; margin-right: 8px;" id="priority-save-btn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                        <path d="M20 6L9 17l-5-5"></path>
                    </svg>
                    Сохранить
                </button>
                <button class="close-panel" onclick="closeDetailPanel()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
                        </div>
                    </div>

        <div class="client-info">
            <div class="client-avatar" id="detail-avatar">АЧ</div>
            <div class="client-details">
                <h3 id="detail-client-name">Алексей Чернов</h3>
                <p id="detail-product">Диван "Неаполь" с механизмом аккордеон</p>
                    </div>
                </div>

        <div class="detail-info" id="main-info">

        <div class="order-details">
            <div class="detail-item">
                <label>Статус заказа</label>
                <div class="field-content">
                    <span class="info-value" id="status-display">Новый заказ</span>
                    <div style="display: none;" id="status-edit-container">
                        <select class="field-select" id="status-input">
                            <option value="new">Новый заказ</option>
                            <option value="production">В производстве</option>
                            <option value="ready">Готов к отгрузке</option>
                            <option value="shipped">Отгружен</option>
                            <option value="completed">Завершен</option>
                        </select>
                    </div>
                </div>
                    </div>
            
            <div class="detail-item">
                <button id="production-toggle" onclick="toggleProductionMarker()" class="sewing-status-button">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="sewing-icon">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        <path d="M8 12h8v2H8v-2z"/>
                        <path d="M10 8h4v2h-4V8z"/>
                        <path d="M11 6h2v2h-2V6z"/>
                    </svg>
                    <div class="sewing-content">
                        <div class="sewing-title" id="toggle-text">В пошиве</div>
                        <div class="sewing-description">Параллельный пошив</div>
                    </div>
                </button>
                    </div>
            <div class="detail-item">
                <label>Приоритет</label>
                <div class="field-content">
                    <span class="info-value" id="priority-display">Высокий</span>
                    <div style="display: none;" id="priority-edit-container">
                        <select class="field-select" id="priority-input">
                            <option value="high">Высокий</option>
                            <option value="medium">Средний</option>
                            <option value="low">Низкий</option>
                        </select>
                    </div>
                </div>
                    </div>
            <div class="detail-item">
                <label>Сумма сделки</label>
                <div class="field-content">
                    <span class="field-value" id="amount-display">42 500 ₽</span>
                    <input type="text" class="field-input" id="amount-input" value="42 500" style="display: none;">
                </div>
            </div>
            <div class="detail-item">
                <label>Предоплата</label>
                <div class="field-content">
                    <span class="field-value" id="prepayment-display">15 000 ₽</span>
                    <input type="text" class="field-input" id="prepayment-input" value="15 000" style="display: none;">
                </div>
            </div>
            <div class="detail-item">
                <label>Дедлайн</label>
                <div class="field-content">
                    <span class="field-value" id="deadline-display">31.01.2024</span>
                    <input type="date" class="field-input" id="deadline-input" value="2024-01-31" style="display: none;">
                </div>
            </div>
            
            <!-- Кнопки действий для основной информации -->
            <div class="detail-actions" id="main-info-actions" style="display: none;">
                <button class="btn btn-secondary" onclick="cancelEdit('main-info')">Отмена</button>
                <button class="btn btn-primary" onclick="saveMainInfo()">Сохранить</button>
            </div>
        </div>

        <!-- Объединенный блок контактов и доставки -->
        <div class="unified-contact-delivery-section" id="unified-contact-delivery">
            <div class="section-header">
                <h3>Контакт и доставка</h3>
                <button class="edit-btn" onclick="toggleEditMode('unified-contact-delivery')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </button>
            </div>
            
            <div class="unified-content">
                <!-- Левая колонка - Контактная информация -->
                <div class="contact-column">
                    <div class="column-header">
                        <h4>Контактная информация</h4>
                    </div>
                    <div class="info-grid">
                        <div class="info-field">
                            <label>ФИО клиента</label>
                            <div class="field-content">
                                <span class="info-value" id="unified-client-name-display">Алексей Чернов</span>
                                <input type="text" class="field-input" id="unified-client-name-input" value="Алексей Чернов" style="display: none;">
                            </div>
                        </div>
                        
                        <div class="info-field">
                            <label>Телефон</label>
                            <div class="field-content">
                                <span class="info-value" id="unified-phone-display">+7 (999) 123-45-67</span>
                                <input type="tel" class="field-input" id="unified-phone-input" value="+7 (999) 123-45-67" style="display: none;">
                            </div>
                        </div>
                        
                        <div class="info-field">
                            <label>Email</label>
                            <div class="field-content">
                                <span class="info-value" id="unified-email-display">alexey.chernov@email.com</span>
                                <input type="email" class="field-input" id="unified-email-input" value="alexey.chernov@email.com" style="display: none;">
                            </div>
                        </div>
                        
                        <div class="info-field">
                            <label>Компания</label>
                            <div class="field-content">
                                <span class="info-value" id="unified-company-display">ООО "Мебель Плюс"</span>
                                <input type="text" class="field-input" id="unified-company-input" value="ООО "Мебель Плюс"" style="display: none;">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Правая колонка - Информация о доставке -->
                <div class="delivery-column">
                    <div class="column-header">
                        <h4>Информация о доставке</h4>
                    </div>
                    <div class="info-grid">
                        <div class="info-field">
                            <label>Адрес доставки</label>
                            <div class="field-content">
                                <span class="info-value" id="unified-address-display">г. Москва, ул. Ленина, д. 45, кв. 18</span>
                                <textarea class="field-textarea" id="unified-address-input" style="display: none;">г. Москва, ул. Ленина, д. 45, кв. 18</textarea>
                            </div>
                        </div>
                        
                        <div class="info-field">
                            <label>Дата доставки</label>
                            <div class="field-content">
                                <span class="info-value" id="unified-delivery-date-display">25.09.2023</span>
                                <input type="date" class="field-input" id="unified-delivery-date-input" value="2023-09-25" style="display: none;">
                            </div>
                        </div>
                        
                        <div class="info-field">
                            <label>Время доставки</label>
                            <div class="field-content">
                                <span class="info-value" id="unified-delivery-time-display">14:00 - 18:00</span>
                                <select class="field-select" id="unified-delivery-time-input" style="display: none;">
                                    <option value="09:00-12:00">09:00 - 12:00</option>
                                    <option value="12:00-15:00">12:00 - 15:00</option>
                                    <option value="14:00-18:00" selected>14:00 - 18:00</option>
                                    <option value="18:00-21:00">18:00 - 21:00</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="info-field">
                            <label>Способ доставки</label>
                            <div class="field-content">
                                <span class="info-value" id="unified-delivery-method-display">Самовывоз</span>
                                <select class="field-select" id="unified-delivery-method-input" style="display: none;">
                                    <option value="pickup">Самовывоз</option>
                                    <option value="courier">Курьерская доставка</option>
                                    <option value="transport">Транспортная компания</option>
                                    <option value="post">Почта России</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Кнопки действий для объединенного блока -->
            <div class="detail-actions" id="unified-contact-delivery-actions" style="display: none;">
                <button class="btn btn-secondary" onclick="cancelEdit('unified-contact-delivery')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    Отмена
                </button>
                <button class="btn btn-primary" onclick="saveUnifiedContactDelivery()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                        <path d="M20 6L9 17l-5-5"></path>
                    </svg>
                    Сохранить
                </button>
            </div>
        </div>

        <div class="panel-tabs">
            <div class="tab active" data-tab="comments">Комментарии</div>
            <div class="tab" data-tab="finance">Финансы</div>
            <div class="tab" data-tab="materials">Материалы</div>
            <div class="tab" data-tab="contacts">Контакты</div>
        </div>

        <div class="tab-content active" id="comments-tab">
            <!-- Блок краткого описания -->
            <div class="project-description-section" id="short-description">
                <div class="section-header">
                    <h3>Краткое описание</h3>
                    <button class="edit-btn" onclick="toggleEditMode('short-description')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="project-description-content">
                    <div class="description-field">
                        <label>Краткое описание (для карточки)</label>
                        <div class="field-content">
                            <span class="field-value" id="short-description-display">Диван "Неаполь" 200x90x85 см, аккордеон</span>
                            <textarea class="field-textarea" id="short-description-input" style="display: none;" placeholder="Название, размеры, механизм...">Диван "Неаполь" 200x90x85 см, аккордеон</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="detail-actions" id="short-description-actions" style="display: none;">
                    <button class="btn btn-secondary" onclick="cancelEdit('short-description')">Отмена</button>
                    <button class="btn btn-primary" onclick="saveShortDescription()">Сохранить</button>
                </div>
            </div>

            <!-- Блок подробного описания -->
            <div class="project-description-section" id="detailed-description">
                <div class="section-header">
                    <h3>Подробное описание</h3>
                    <button class="edit-btn" onclick="toggleEditMode('detailed-description')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="project-description-content">
                    <div class="description-field">
                        <label>Подробное описание проекта</label>
                        <div class="field-content">
                            <span class="field-value" id="detailed-description-display">Классический диван с механизмом аккордеон, обивка из велюра, цвет - темно-синий. Размеры: 200x90x85 см. Дополнительно: подушки в комплекте, ножки из массива дуба.</span>
                            <textarea class="field-textarea" id="detailed-description-input" style="display: none;" placeholder="Полное описание проекта...">Классический диван с механизмом аккордеон, обивка из велюра, цвет - темно-синий. Размеры: 200x90x85 см. Дополнительно: подушки в комплекте, ножки из массива дуба.</textarea>
                        </div>
                    </div>
                    
                </div>
                
                <div class="detail-actions" id="detailed-description-actions" style="display: none;">
                    <button class="btn btn-secondary" onclick="cancelEdit('detailed-description')">Отмена</button>
                    <button class="btn btn-primary" onclick="saveDetailedDescription()">Сохранить</button>
                </div>
            </div>
            
            <!-- Чертежи и файлы -->
            <div class="drawings-section">
                <div class="section-header">
                    <h3>Чертежи и документы</h3>
                    <button class="add-file-btn" onclick="addNewFile()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                        </svg>
                        Добавить файл
                    </button>
                </div>
                
                <div class="files-list" id="files-list">
                    <div class="file-download">
                        <div class="file-info">
                            <div class="file-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                    <polyline points="10 9 9 9 8 9"></polyline>
                                </svg>
                            </div>
                            <div>
                                <div class="file-name">Чертеж дивана.pdf</div>
                                <div class="file-size">2.4 МБ</div>
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="download-btn" onclick="downloadFile('test-1', 'Чертеж дивана.pdf')">Скачать</button>
                            <button class="delete-btn" onclick="deleteFile(this)">×</button>
                        </div>
                    </div>
                    
                    <div class="file-download">
                        <div class="file-info">
                            <div class="file-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14,2 14,8 20,8"></polyline>
                                </svg>
                            </div>
                            <div>
                                <div class="file-name">Спецификация материалов.xlsx</div>
                                <div class="file-size">156 КБ</div>
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="download-btn" onclick="downloadFile('test-1', 'Чертеж дивана.pdf')">Скачать</button>
                            <button class="delete-btn" onclick="deleteFile(this)">×</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Комментарии -->
            <div class="comments-section">
                <div class="section-header">
                    <h3>Комментарии</h3>
                    <button class="add-comment-btn" onclick="addNewComment()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            <path d="M12 5v14M5 12h14"></path>
                        </svg>
                        Добавить комментарий
                    </button>
                            </div>
                
                <div class="comments-list" id="comments-list">
                    <div class="comment">
                        <div class="comment-header">
                            <span class="comment-author">Менеджер</span>
                            <span class="comment-time">10.09.2023 14:30</span>
                            </div>
                        <div class="comment-text">
                            Клиент подтвердил заказ. Предоплата внесена.
                        </div>
                    </div>
                    
                    <div class="comment">
                        <div class="comment-header">
                            <span class="comment-author">Алексей Чернов</span>
                            <span class="comment-time">11.09.2023 10:15</span>
                        </div>
                        <div class="comment-text">
                            Уточнил детали по цвету обивки. Отправил подтверждение на почту.
                        </div>
                    </div>
                        </div>
                    </div>
                </div>

        <div class="tab-content" id="finance-tab">
            <!-- Финансовый блок -->
            <div class="finance-section" id="finance-section">
                <div class="section-header">
                    <h3>Финансовая информация</h3>
                    <button class="edit-btn" onclick="toggleEditMode('finance-section')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Основные финансовые показатели -->
                <div class="finance-stats">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="finance-total-amount">42 500 ₽</div>
                            <div class="stat-label">Общая сумма заказа</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12,6 12,12 16,14"></polyline>
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="finance-prepayment">15 000 ₽</div>
                            <div class="stat-label">Предоплата</div>
                    </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14,2 14,8 20,8"></polyline>
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="finance-remaining">27 500 ₽</div>
                            <div class="stat-label">Остаток к оплате</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="finance-prepayment-percent">35%</div>
                            <div class="stat-label">Процент предоплаты</div>
                </div>
            </div>
        </div>

                <!-- Детальная финансовая информация -->
                <div class="finance-details">
                    <div class="detail-field">
                        <label>Способ оплаты</label>
                        <div class="field-content">
                            <span class="field-value" id="payment-method-display">Банковский перевод</span>
                            <select class="field-select" id="payment-method-input" style="display: none;">
                                <option value="bank_transfer">Банковский перевод</option>
                                <option value="cash">Наличные</option>
                                <option value="card">Банковская карта</option>
                                <option value="installment">Рассрочка</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="detail-field">
                        <label>Дата предоплаты</label>
                        <div class="field-content">
                            <span class="field-value" id="prepayment-date-display">15.09.2023</span>
                            <input type="date" class="field-input" id="prepayment-date-input" value="2023-09-15" style="display: none;">
                        </div>
                    </div>
                    
                    <div class="detail-field">
                        <label>Номер счета</label>
                        <div class="field-content">
                            <span class="field-value" id="invoice-number-display">№ 12345 от 10.09.2023</span>
                            <input type="text" class="field-input" id="invoice-number-input" value="№ 12345 от 10.09.2023" style="display: none;">
                        </div>
                    </div>
                    
                    <div class="detail-field">
                        <label>Дата окончательной оплаты</label>
                        <div class="field-content">
                            <span class="field-value" id="final-payment-date-display">Не установлена</span>
                            <input type="date" class="field-input" id="final-payment-date-input" style="display: none;">
                        </div>
                    </div>
                    
                    <div class="detail-field">
                        <label>Комментарий к оплате</label>
                        <div class="field-content">
                            <span class="field-value" id="payment-comment-display">Предоплата внесена в полном объеме</span>
                            <textarea class="field-textarea" id="payment-comment-input" style="display: none;">Предоплата внесена в полном объеме</textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Кнопки действий -->
                <div class="finance-actions" id="finance-section-actions" style="display: none;">
                    <button class="btn btn-secondary" onclick="cancelEdit('finance-section')">Отмена</button>
                    <button class="btn btn-primary" onclick="saveFinanceData()">Сохранить</button>
                </div>
            </div>
            
            <!-- История платежей -->
            <div class="payments-history-section">
                <div class="section-header">
                    <h3>История платежей</h3>
                    <button class="add-payment-btn" onclick="addNewPayment()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                        Добавить платеж
            </button>
                </div>
                
                <div class="payments-list" id="payments-list">
                    <div class="payment-item">
                        <div class="payment-info">
                            <div class="payment-amount">15 000 ₽</div>
                            <div class="payment-type">Предоплата</div>
                        </div>
                        <div class="payment-details">
                            <div class="payment-date">15.09.2023</div>
                            <div class="payment-method">Банковский перевод</div>
                        </div>
                        <div class="payment-actions">
                            <button class="edit-payment-btn" onclick="editPayment(this)">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button class="delete-payment-btn" onclick="deletePayment(this)">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3,6 5,6 21,6"></polyline>
                                    <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="materials-tab">
            <!-- Блок материалов -->
            <div class="materials-section">
                <div class="section-header">
                    <h3>Материалы</h3>
                    <button class="add-material-btn" onclick="addNewMaterial()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Добавить материал
                    </button>
                </div>
                
                <!-- Таблица материалов -->
                <div class="materials-table-container">
                    <table class="materials-table">
                        <thead>
                            <tr>
                                <th>Наименование</th>
                                <th>Количество</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="materials-table-body">
                            <tr>
                                <td>Ткань мебельная "Велюр"</td>
                                <td>15 м</td>
                                <td>
                                    <button class="edit-material-btn" onclick="editMaterial(this)">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                    </button>
                                    <button class="delete-material-btn" onclick="deleteMaterial(this)">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3,6 5,6 21,6"></polyline>
                                            <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                                            <line x1="10" y1="11" x2="10" y2="17"></line>
                                            <line x1="14" y1="11" x2="14" y2="17"></line>
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td>Наполнитель холлофайбер</td>
                                <td>8 кг</td>
                                <td>
                                    <button class="edit-material-btn" onclick="editMaterial(this)">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                    </button>
                                    <button class="delete-material-btn" onclick="deleteMaterial(this)">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3,6 5,6 21,6"></polyline>
                                            <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                                            <line x1="10" y1="11" x2="10" y2="17"></line>
                                            <line x1="14" y1="11" x2="14" y2="17"></line>
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td>Дерево бук</td>
                                <td>2.5 м³</td>
                                <td>
                                    <button class="edit-material-btn" onclick="editMaterial(this)">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                    </button>
                                    <button class="delete-material-btn" onclick="deleteMaterial(this)">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3,6 5,6 21,6"></polyline>
                                            <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                                            <line x1="10" y1="11" x2="10" y2="17"></line>
                                            <line x1="14" y1="11" x2="14" y2="17"></line>
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td>Фурнитура металлическая</td>
                                <td>комплект</td>
                                <td>
                                    <button class="edit-material-btn" onclick="editMaterial(this)">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                    </button>
                                    <button class="delete-material-btn" onclick="deleteMaterial(this)">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3,6 5,6 21,6"></polyline>
                                            <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                                            <line x1="10" y1="11" x2="10" y2="17"></line>
                                            <line x1="14" y1="11" x2="14" y2="17"></line>
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-content" id="contacts-tab">
            <div class="empty-state">
                <div class="empty-icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9,22 9,12 15,12 15,22"></polyline>
                    </svg>
                </div>
                <h3>Информация перенесена</h3>
                <p>Данные о контактах и доставке теперь находятся в основном блоке выше для удобства редактирования.</p>
            </div>
        </div>
        
        <!-- Кнопка перехода на страницу заказа -->
        <div class="order-page-link-section">
            <button class="btn btn-primary order-page-btn" onclick="goToOrderPage()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9,22 9,12 15,12 15,22"></polyline>
                </svg>
                Перейти на страницу заказа
            </button>
        </div>
    </div>

    <script>
    // Глобальная переменная для отслеживания активной карточки
    let activeCardId = null;
    
    // Функция для вычисления суммы в колонке
    function updateColumnSums() {
        const columns = document.querySelectorAll('.kanban-column');
        
        columns.forEach(column => {
            const cards = column.querySelectorAll('.kanban-card');
            let total = 0;
            
            cards.forEach(card => {
                const amount = parseInt(card.getAttribute('data-card-amount') || '0');
                total += amount;
            });
            
            const sumElement = column.querySelector('.column-sum');
            if (sumElement) {
                sumElement.textContent = total.toLocaleString('ru-RU') + ' ₽';
            }
        });
    }
    
    // Функция для редактирования заголовка колонки
    function startEditingColumnTitle(column) {
        const titleElement = column.querySelector('.column-title span:first-child');
        const currentTitle = titleElement.textContent;
        const countSpan = column.querySelector('.column-count');
        const sumSpan = column.querySelector('.column-sum');
        
        const input = document.createElement('input');
        input.type = 'text';
        input.value = currentTitle;
        input.className = 'column-title-input';
        
        // Заменяем содержимое на input
        titleElement.replaceWith(input);
        
        input.focus();
        
        // Обработка завершения редактирования
        input.addEventListener('blur', function() {
            finishEditingColumnTitle(input, countSpan, sumSpan);
        });
        
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                finishEditingColumnTitle(input, countSpan, sumSpan);
            }
        });
    }
    
    function finishEditingColumnTitle(input, countSpan, sumSpan) {
        const newTitle = input.value || 'Без названия';
        const titleSpan = document.createElement('span');
        titleSpan.textContent = newTitle;
        
        input.replaceWith(titleSpan);
        
        // Восстанавливаем счетчик и сумму
        if (countSpan) {
            titleSpan.after(countSpan);
        }
        if (sumSpan) {
            countSpan.after(sumSpan);
        }
    }
    
    // Функция для показа/скрытия формы добавления карточки
    function toggleAddCardForm(element) {
        const column = element.closest('.kanban-column');
        const form = column.querySelector('.add-card-form');
        const isVisible = form.style.display === 'block';
        
        form.style.display = isVisible ? 'none' : 'block';
    }
    
    function cancelAddCard(button) {
        const form = button.closest('.add-card-form');
        form.style.display = 'none';
    }
    
    async function addNewCard(button) {
        const form = button.closest('.add-card-form');
        const inputs = form.querySelectorAll('.form-input');
        
        // Собираем данные из формы
        const formData = {};
        inputs.forEach(input => {
            const placeholder = input.placeholder;
            if (placeholder.includes('Название изделия')) {
                formData.product_name = input.value;
            } else if (placeholder.includes('Сумма заказа')) {
                formData.total_amount = parseFloat(input.value) || 0;
            } else if (placeholder.includes('Предоплата')) {
                formData.prepayment_amount = parseFloat(input.value) || 0;
            } else if (placeholder.includes('Имя клиента')) {
                formData.customer_name = input.value;
            } else if (input.tagName === 'SELECT') {
                formData.priority = input.value;
            }
        });
        
        // Валидация обязательных полей
        if (!formData.product_name || !formData.customer_name) {
            alert('Пожалуйста, заполните название изделия и имя клиента');
            return;
        }
        
        try {
            // Получаем токен
            const token = localStorage.getItem('token') || 'test-token';
            
            // Сначала создаем клиента
            const customerResponse = await fetch('http://localhost:5000/api/customers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    name: formData.customer_name,
                    email: '',
                    phone: '',
                    company: '',
                    address: '',
                    notes: 'Создан через канбан-доску'
                })
            });
            
            if (!customerResponse.ok) {
                throw new Error(`Ошибка создания клиента: HTTP ${customerResponse.status}`);
            }
            
            const customerResult = await customerResponse.json();
            const customerId = customerResult.customer.id;
            
            // Теперь создаем заказ
            const orderResponse = await fetch('http://localhost:5000/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    customer_id: customerId,
                    product_name: formData.product_name,
                    status: 'in_production', // Сразу в производство для канбана
                    priority: formData.priority || 'normal',
                    total_amount: formData.total_amount,
                    prepayment_amount: formData.prepayment_amount,
                    delivery_date: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString(), // +14 дней
                    notes: 'Создано через канбан-доску',
                    items: [{
                        name: formData.product_name,
                        description: 'Основное изделие',
                        quantity: 1,
                        unit_price: formData.total_amount
                    }]
                })
            });
            
            if (!orderResponse.ok) {
                throw new Error(`Ошибка создания заказа: HTTP ${orderResponse.status}`);
            }
            
            const orderResult = await orderResponse.json();
            console.log('Заказ создан:', orderResult);
            
            // Показываем уведомление об успехе
            alert(`Заказ ${orderResult.order_number} успешно создан!`);
            
            // Очищаем форму и скрываем ее
            inputs.forEach(input => input.value = '');
            form.style.display = 'none';
            
            // Перезагружаем данные канбана
            await loadKanbanData();
            
        } catch (error) {
            console.error('Ошибка создания заказа:', error);
            alert('Ошибка при создании заказа: ' + error.message);
        }
    }
    
    // Функции для работы с детальной панелью
    function openDetailPanel(card) {
        console.log('openDetailPanel called with card:', card);
        console.log('Function is working!');
        // alert('openDetailPanel called!'); // Временный тест
        const panel = document.getElementById('detail-panel');
        const overlay = document.getElementById('overlay');
        
        console.log('Panel found:', !!panel);
        console.log('Overlay found:', !!overlay);
        
        if (!panel) {
            console.error('Detail panel not found!');
            return;
        }
        if (!overlay) {
            console.error('Overlay not found!');
            return;
        }
        
        if (!panel || !overlay) {
            console.error('Panel or overlay not found!');
            return;
        }
        
        // Сохраняем ID активной карточки
        activeCardId = card.getAttribute('data-card-id');
        console.log('Setting active card ID:', activeCardId);
        
        // Заполняем данные на панели (в реальном приложении данные будут приходить с сервера)
        const clientNameEl = card.querySelector('.client-name');
        const clientAvatarEl = card.querySelector('.client-avatar');
        const productNameEl = card.querySelector('.card-title');
        const amountEl = card.querySelector('.card-amount');
        const prepaymentEl = card.querySelector('.prepayment');
        const contactEl = card.querySelector('.card-contact');
        
        const clientName = clientNameEl ? clientNameEl.textContent : 'Клиент';
        const clientAvatar = clientAvatarEl ? clientAvatarEl.textContent : 'К';
        const productName = productNameEl ? productNameEl.textContent : 'Изделие';
        const amount = amountEl ? amountEl.textContent : '0 ₽';
        const prepayment = prepaymentEl ? prepaymentEl.textContent.replace('Предоплата: ', '') : '0 ₽';
        const contact = contactEl ? contactEl.textContent.replace('📞 ', '') : '';
        
        const statusCircle = card.querySelector('.status-circle');
        const priority = statusCircle ? (statusCircle.textContent === 'В' ? 'Высокий' : 
                        statusCircle.textContent === 'С' ? 'Средний' : 'Низкий') : 'Средний';
        
        // Извлекаем дедлайн из карточки (ищем в card-dates или создаем по умолчанию)
        let deadline = '31.01.2024'; // По умолчанию
        const datesElement = card.querySelector('.card-dates');
        if (datesElement) {
            const deadlineSpan = datesElement.querySelector('.deadline');
            if (deadlineSpan) {
                // Извлекаем только текст даты, убирая иконку
                deadline = deadlineSpan.textContent.trim();
            }
        }
        
        document.getElementById('detail-avatar').textContent = clientAvatar;
        document.getElementById('detail-client-name').textContent = clientName;
        document.getElementById('detail-product').textContent = productName;
        
        // Заполняем поля суммы и предоплаты
        const amountDisplay = document.getElementById('amount-display');
        const amountInput = document.getElementById('amount-input');
        const prepaymentDisplay = document.getElementById('prepayment-display');
        const prepaymentInput = document.getElementById('prepayment-input');
        
        if (amountDisplay && amountInput) {
            amountDisplay.textContent = amount;
            // Извлекаем числовое значение из строки "42 500 ₽"
            const amountValue = amount.replace(/[^\d]/g, '');
            amountInput.value = amountValue || '0';
        }
        
        if (prepaymentDisplay && prepaymentInput) {
            prepaymentDisplay.textContent = prepayment;
            // Извлекаем числовое значение из строки "15 000 ₽"
            const prepaymentValue = prepayment.replace(/[^\d]/g, '');
            prepaymentInput.value = prepaymentValue || '0';
        }
        
        document.getElementById('priority-display').textContent = priority;
        
        
        // Заполняем дополнительные поля
        const additionalContactEl = document.getElementById('client-additional-display');
        
        if (additionalContactEl) additionalContactEl.textContent = contact || 'Дополнительный контакт не указан';
        
        // Загружаем полные данные заказа из API для получения описания проекта
        loadOrderDetails(activeCardId);
        
        // Устанавливаем значение в select приоритета
        const priorityInput = document.getElementById('priority-input');
        if (priorityInput) {
            const priorityValue = priority === 'Высокий' ? 'high' : 
                                 priority === 'Средний' ? 'medium' : 'low';
            priorityInput.value = priorityValue;
        }
        
        // Устанавливаем статус заказа (по умолчанию "Новый заказ")
        const statusDisplay = document.getElementById('status-display');
        const statusInput = document.getElementById('status-input');
        if (statusDisplay) {
            statusDisplay.textContent = 'Новый заказ';
        }
        if (statusInput) {
            statusInput.value = 'new';
        }
        document.getElementById('deadline-display').textContent = deadline;
        
        // Синхронизируем кнопку "В пошиве" с состоянием статуса
        const productionStatus = card.querySelector('.production-status');
        const toggle = document.getElementById('production-toggle');
        const toggleText = document.getElementById('toggle-text');
        
        if (productionStatus && toggle) {
            // Проверяем, виден ли статус
            const isVisible = productionStatus.style.display !== 'none' && productionStatus.style.display !== '';
            
            // Обновляем класс кнопки
            if (isVisible) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
            
            // Добавляем обработчик события
            toggle.onclick = function() {
                if (activeCardId) {
                    const activeCard = document.querySelector(`[data-card-id="${activeCardId}"]`);
                    if (activeCard) {
                        const statusElement = activeCard.querySelector('.production-status');
                        if (statusElement) {
                            if (statusElement.style.display === 'none' || statusElement.style.display === '') {
                                statusElement.style.display = 'block';
                                toggle.classList.add('active');
                                console.log('Marker shown');
                            } else {
                                statusElement.style.display = 'none';
                                toggle.classList.remove('active');
                                console.log('Marker hidden');
                            }
                        }
                    }
                }
            };
        }
        
        // Показываем панель и overlay
        console.log('Showing panel and overlay...');
        panel.classList.add('active');
        overlay.classList.add('active');
        console.log('Panel classes:', panel.className);
        console.log('Overlay classes:', overlay.className);
        
        // Инициализируем табы с небольшой задержкой
        setTimeout(() => {
            initTabs();
            // Обновляем данные в табах
            updateTabData(card);
        }, 50);
        
        // Блокируем скролл на основном контенте
        document.body.style.overflow = 'hidden';
    }
    
    function closeDetailPanel() {
        const panel = document.getElementById('detail-panel');
        const overlay = document.getElementById('overlay');
        
        panel.classList.remove('active');
        overlay.classList.remove('active');
        
        // Разблокируем скролл на основном контенте
        document.body.style.overflow = '';
    }
    
    // Функция для удаления колонки
    function deleteColumn(columnElement) {
        const columnId = columnElement.getAttribute('data-column-id');
        const columnTitle = columnElement.querySelector('.column-title span').textContent;
        const cardCount = columnElement.querySelectorAll('.kanban-card').length;
        
        // Список системных колонок, которые нельзя удалять
        const systemColumns = [
            'КБ', 'Столярный цех', 'Формовка', 'Швейный цех', 
            'Обивка', 'Сборка и упаковка', 'Отгружен'
        ];
        
        // Проверяем, является ли колонка системной
        if (systemColumns.includes(columnTitle)) {
            alert(`Колонка "${columnTitle}" является системной и не может быть удалена.`);
            return;
        }
        
        // Проверяем, есть ли карточки в колонке
        if (cardCount > 0) {
            const confirmMessage = `В колонке "${columnTitle}" есть ${cardCount} карточек. При удалении колонки все карточки будут перемещены в первую колонку. Продолжить?`;
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Перемещаем все карточки в первую колонку
            const firstColumn = document.querySelector('.kanban-column[data-column-id="1"]');
            if (firstColumn) {
                const firstColumnCards = firstColumn.querySelector('.kanban-cards');
                const cardsToMove = columnElement.querySelectorAll('.kanban-card');
                
                cardsToMove.forEach(card => {
                    firstColumnCards.appendChild(card);
                });
            }
        }
        
        // Удаляем колонку
        columnElement.remove();
        
        // Обновляем ID оставшихся колонок
        updateColumnIds();
        
        // Обновляем суммы и счетчики
        updateColumnSums();
        updateColumnCounts();
        
        console.log(`Колонка "${columnTitle}" удалена`);
    }
    
    // Функция для обновления ID колонок после удаления
    function updateColumnIds() {
        const columns = document.querySelectorAll('.kanban-column');
        columns.forEach((column, index) => {
            const newId = index + 1;
            column.setAttribute('data-column-id', newId);
            
            // Обновляем ID в элементах суммы и счетчика
            const sumElement = column.querySelector('.column-sum');
            const countElement = column.querySelector('.column-count');
            
            if (sumElement) {
                sumElement.id = `column-sum-${newId}`;
            }
            if (countElement) {
                countElement.id = `column-count-${newId}`;
            }
        });
    }
    
    // Функция для создания новой колонки
    function createNewColumn() {
        const kanbanBoard = document.getElementById('kanban-board');
        const columnCount = kanbanBoard.querySelectorAll('.kanban-column').length;
        const newColumnId = columnCount + 1;
        
        const newColumn = document.createElement('div');
        newColumn.className = 'kanban-column';
        newColumn.setAttribute('data-column-id', newColumnId);
        
        newColumn.innerHTML = `
            <div class="column-header">
                <div class="column-title">
                    <span>Новая колонка</span>
                    <span class="column-sum">0 ₽</span>
                    <span class="column-count">0</span>
                </div>
                <div class="column-actions">
                    <div class="column-action" onclick="startEditingColumnTitle(this.closest('.kanban-column'))">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </div>
                    <div class="column-action" onclick="toggleAddCardForm(this)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"></path>
                        </svg>
                    </div>
                    <div class="column-action column-delete" onclick="deleteColumn(this.closest('.kanban-column'))">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6"></path>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="kanban-cards"></div>
            <div class="add-card-form" style="display: none;">
                <div class="form-group">
                    <input type="text" class="form-input" placeholder="Название изделия">
                </div>
                <div class="form-group">
                    <input type="number" class="form-input" placeholder="Сумма заказа">
                </div>
                <div class="form-group">
                    <input type="number" class="form-input" placeholder="Предоплата">
                </div>
                <div class="form-group">
                    <select class="form-input">
                        <option value="high">Высокий приоритет</option>
                        <option value="medium">Средний приоритет</option>
                        <option value="low">Низкий приоритет</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="text" class="form-input" placeholder="Имя клиента">
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="cancelAddCard(this)">Отмена</button>
                    <button class="btn btn-primary" onclick="addNewCard(this)">Добавить</button>
                </div>
            </div>
        `;
        
        // Добавляем новую колонку в доску
        kanbanBoard.appendChild(newColumn);
        
        // Инициализируем функционал перетаскивания для новой колонки
        initColumnDragAndDrop(newColumn);
        
        // Закрываем панель после создания колонки
        closeDetailPanel();
    }
    
    // Функция для инициализации табов
    function initTabs() {
        console.log('Initializing tabs...');
        
        // Удаляем старые обработчики
        document.querySelectorAll('.tab').forEach(tab => {
            tab.removeEventListener('click', handleTabClick);
        });
        
        // Добавляем новые обработчики
        const tabs = document.querySelectorAll('.tab');
        console.log('Found tabs:', tabs.length);
        
        tabs.forEach((tab, index) => {
            console.log(`Tab ${index}:`, tab.getAttribute('data-tab'));
            tab.addEventListener('click', handleTabClick);
        });
        
        // Убеждаемся, что первый таб активен
        if (tabs.length > 0) {
            tabs[0].classList.add('active');
            const firstTabId = tabs[0].getAttribute('data-tab');
            const firstTabContent = document.getElementById(`${firstTabId}-tab`);
            if (firstTabContent) {
                firstTabContent.classList.add('active');
                console.log('First tab activated:', firstTabId);
            }
        }
    }
    
    function handleTabClick() {
        console.log('Tab clicked:', this.getAttribute('data-tab'));
        
        // Убираем активный класс у всех табов
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        // Добавляем активный класс текущему табу
        this.classList.add('active');
        
        // Скрываем все содержимое табов
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        // Показываем содержимое выбранного таба
        const tabId = this.getAttribute('data-tab');
        const targetTab = document.getElementById(`${tabId}-tab`);
        console.log('Looking for tab content:', `${tabId}-tab`, 'Found:', !!targetTab);
        
        if (targetTab) {
            targetTab.classList.add('active');
            console.log('Tab content activated:', tabId);
        } else {
            console.error('Tab content not found:', `${tabId}-tab`);
        }
    }
    
    // Функция для обновления данных в табах
    function updateTabData(card) {
        const clientName = card.querySelector('.client-name').textContent;
        const amount = card.querySelector('.card-amount').textContent;
        const prepayment = card.querySelector('.prepayment').textContent.replace('Предоплата: ', '');
        const productName = card.querySelector('.card-title').textContent;
        
        // Обновляем данные в табе "Комментарии" (описание проекта)
        updateProjectDescription(productName);
        
        // Обновляем данные в табе "Финансы"
        updateFinanceData(amount, prepayment);
        
        // Обновляем данные в табе "Контакты"
        updateContactsData(clientName);
    }
    
    // Функция для обновления контактных данных
    function updateContactsData(clientName) {
        const nameDisplay = document.getElementById('client-name-display');
        const nameInput = document.getElementById('client-name-input');
        
        if (nameDisplay && nameInput) {
            nameDisplay.textContent = clientName;
            nameInput.value = clientName;
        }
        
        // Обновляем аватар в детальной панели
        const avatarElement = document.getElementById('detail-avatar');
        if (avatarElement) {
            const initials = clientName.split(' ').map(word => word[0]).join('').toUpperCase();
            avatarElement.textContent = initials;
        }
    }
    
    // Функция для обновления финансовых данных
    function updateFinanceData(amount, prepayment) {
        const totalAmountElement = document.getElementById('finance-total-amount');
        const prepaymentElement = document.getElementById('finance-prepayment');
        
        if (totalAmountElement) totalAmountElement.textContent = amount;
        if (prepaymentElement) prepaymentElement.textContent = prepayment;
        
        // Вычисляем остаток к оплате
        const totalAmount = parseFloat(amount.replace(/[^\d]/g, ''));
        const prepaymentAmount = parseFloat(prepayment.replace(/[^\d]/g, ''));
        const remaining = totalAmount - prepaymentAmount;
        const prepaymentPercent = Math.round((prepaymentAmount / totalAmount) * 100);
        
        const remainingElement = document.getElementById('finance-remaining');
        const percentElement = document.getElementById('finance-prepayment-percent');
        
        if (remainingElement) remainingElement.textContent = remaining.toLocaleString('ru-RU') + ' ₽';
        if (percentElement) percentElement.textContent = prepaymentPercent + '%';
    }
    
    // Функция для обновления описания проекта
    function updateProjectDescription(productName) {
        const nameDisplay = document.getElementById('project-name-display');
        const nameInput = document.getElementById('project-name-input');
        
        if (nameDisplay && nameInput) {
            nameDisplay.textContent = productName;
            nameInput.value = productName;
        }
    }
    
    // Функции для редактирования описания проекта
    function toggleEditMode(section) {
        console.log('toggleEditMode called with section:', section);
        
        // Ищем элементы по разным возможным селекторам
        let actions = document.getElementById(`${section}-actions`);
        let displayElements = document.querySelectorAll(`#${section} .field-value, #${section} .info-value`);
        let inputElements = document.querySelectorAll(`#${section} .field-input, #${section} .field-textarea, #${section} .field-select`);
        
        // Специальная обработка для финансовой секции
        if (section === 'finance-section' && !actions) {
            actions = document.getElementById('finance-section-actions');
        }
        
        // Специальная обработка для main-info секции
        if (section === 'main-info') {
            const isEditing = actions && actions.style.display !== 'none';
            
            if (isEditing) {
                // Выходим из режима редактирования
                if (actions) actions.style.display = 'none';
                
                // Скрываем поля ввода и показываем отображение
                const fields = [
                    { display: 'status-display', input: 'status-edit-container' },
                    { display: 'priority-display', input: 'priority-edit-container' },
                    { display: 'amount-display', input: 'amount-input' },
                    { display: 'prepayment-display', input: 'prepayment-input' },
                    { display: 'deadline-display', input: 'deadline-input' }
                ];
                
                fields.forEach(field => {
                    const displayEl = document.getElementById(field.display);
                    const inputEl = document.getElementById(field.input);
                    if (displayEl) displayEl.style.display = 'inline';
                    if (inputEl) inputEl.style.display = 'none';
                });
            } else {
                // Входим в режим редактирования
                if (actions) actions.style.display = 'flex';
                
                // Показываем поля ввода и скрываем отображение
                const fields = [
                    { display: 'status-display', input: 'status-edit-container' },
                    { display: 'priority-display', input: 'priority-edit-container' },
                    { display: 'amount-display', input: 'amount-input' },
                    { display: 'prepayment-display', input: 'prepayment-input' },
                    { display: 'deadline-display', input: 'deadline-input' }
                ];
                
                fields.forEach(field => {
                    const displayEl = document.getElementById(field.display);
                    const inputEl = document.getElementById(field.input);
                    if (displayEl) displayEl.style.display = 'none';
                    if (inputEl) inputEl.style.display = 'block';
                });
            }
            return;
        }
        
        // Если не найдены, ищем по классу
        if (!actions) {
            actions = document.querySelector(`.${section}-actions`);
        }
        if (displayElements.length === 0) {
            displayElements = document.querySelectorAll(`.${section} .field-value, .${section} .info-value`);
        }
        if (inputElements.length === 0) {
            inputElements = document.querySelectorAll(`.${section} .field-input, .${section} .field-textarea, .${section} .field-select`);
        }
        
        // Если все еще не найдены, ищем по родительскому элементу
        if (displayElements.length === 0 || inputElements.length === 0) {
            const sectionElement = document.querySelector(`#${section}`) || document.querySelector(`.${section}`);
            if (sectionElement) {
                displayElements = sectionElement.querySelectorAll('.field-value, .info-value');
                inputElements = sectionElement.querySelectorAll('.field-input, .field-textarea, .field-select');
            }
        }
        
        console.log('Found elements:', {
            actions: !!actions,
            displayElements: displayElements.length,
            inputElements: inputElements.length
        });
        
        if (actions && displayElements.length > 0 && inputElements.length > 0) {
            const isEditing = actions.style.display !== 'none' && actions.style.display !== '';
            
            if (isEditing) {
                // Выходим из режима редактирования
                displayElements.forEach(el => el.style.display = 'block');
                inputElements.forEach(el => el.style.display = 'none');
                actions.style.display = 'none';
                console.log('Exiting edit mode');
            } else {
                // Входим в режим редактирования
                displayElements.forEach(el => el.style.display = 'none');
                inputElements.forEach(el => el.style.display = 'block');
                actions.style.display = 'flex';
                console.log('Entering edit mode');
            }
        } else {
            console.error('Could not find required elements for section:', section);
        }
    }
    
    function cancelEdit(section) {
        // Специальная обработка для main-info секции
        if (section === 'main-info') {
            const actions = document.getElementById(`${section}-actions`);
            if (actions) {
                // Восстанавливаем значения из display элементов
                const fields = [
                    { display: 'status-display', input: 'status-edit-container' },
                    { display: 'priority-display', input: 'priority-edit-container' },
                    { display: 'amount-display', input: 'amount-input' },
                    { display: 'prepayment-display', input: 'prepayment-input' },
                    { display: 'deadline-display', input: 'deadline-input' }
                ];
                
                fields.forEach(field => {
                    const displayEl = document.getElementById(field.display);
                    const inputEl = document.getElementById(field.input);
                    if (displayEl && inputEl) {
                        if (field.input === 'deadline-input') {
                            // Для даты нужно конвертировать обратно в формат YYYY-MM-DD
                            const dateText = displayEl.textContent;
                            if (dateText) {
                                const date = new Date(dateText.split('.').reverse().join('-'));
                                inputEl.value = date.toISOString().split('T')[0];
                            }
                        } else if (field.input === 'amount-input' || field.input === 'prepayment-input') {
                            // Для сумм убираем символ ₽
                            inputEl.value = displayEl.textContent.replace(' ₽', '');
                        } else if (field.input === 'status-edit-container' || field.input === 'priority-edit-container') {
                            // Для статуса и приоритета восстанавливаем выбранное значение
                            const displayText = displayEl.textContent;
                            const select = inputEl.querySelector('select');
                            if (select) {
                                for (let option of select.options) {
                                    if (option.text === displayText) {
                                        select.value = option.value;
                                        break;
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Выходим из режима редактирования
                toggleEditMode('main-info');
            }
            return;
        }
        
        const actions = document.getElementById(`${section}-actions`);
        const displayElements = document.querySelectorAll(`#${section} .field-value, #${section} .info-value`);
        const inputElements = document.querySelectorAll(`#${section} .field-input, #${section} .field-textarea, #${section} .field-select`);
        
        if (actions && displayElements.length > 0 && inputElements.length > 0) {
            // Восстанавливаем значения из display элементов
            inputElements.forEach((input, index) => {
                if (displayElements[index]) {
                    input.value = displayElements[index].textContent;
                }
            });
            
            // Выходим из режима редактирования
            displayElements.forEach(el => el.style.display = 'block');
            inputElements.forEach(el => el.style.display = 'none');
            actions.style.display = 'none';
        }
    }
    
    function saveProjectDescription() {
        const nameDisplay = document.getElementById('project-name-display');
        const nameInput = document.getElementById('project-name-input');
        const descriptionDisplay = document.getElementById('project-description-display');
        const descriptionInput = document.getElementById('project-description-input');
        const requirementsDisplay = document.getElementById('project-requirements-display');
        const requirementsInput = document.getElementById('project-requirements-input');
        
        // Сохраняем значения
        if (nameDisplay && nameInput) {
            nameDisplay.textContent = nameInput.value;
        }
        if (descriptionDisplay && descriptionInput) {
            descriptionDisplay.textContent = descriptionInput.value;
        }
        if (requirementsDisplay && requirementsInput) {
            requirementsDisplay.textContent = requirementsInput.value;
        }
        
        // Выходим из режима редактирования
        toggleEditMode('project-description');
        
        // Обновляем данные в карточке
        updateCardProjectData();
        
        // Здесь можно добавить сохранение на сервер
        console.log('Описание проекта сохранено:', {
            name: nameInput.value,
            description: descriptionInput.value,
            requirements: requirementsInput.value
        });
    }
    
    // Функция для обновления данных проекта в карточке
    function updateCardProjectData() {
        if (activeCardId) {
            const activeCard = document.querySelector(`[data-card-id="${activeCardId}"]`);
            if (activeCard) {
                // Обновляем название проекта в карточке
                const titleElement = activeCard.querySelector('.card-title');
                const projectNameDisplay = document.getElementById('project-name-display');
                
                if (titleElement && projectNameDisplay) {
                    titleElement.textContent = projectNameDisplay.textContent;
                }
                
                // Обновляем данные в детальной панели
                const detailProduct = document.getElementById('detail-product');
                if (detailProduct && projectNameDisplay) {
                    detailProduct.textContent = projectNameDisplay.textContent;
                }
            }
        }
    }
    
    // Функции для работы с файлами
    function addNewFile() {
        const input = document.createElement('input');
        input.type = 'file';
        input.multiple = true;
        input.accept = '.pdf,.doc,.docx,.xlsx,.jpg,.png,.dwg';
        
        input.onchange = function(e) {
            Array.from(e.target.files).forEach(file => {
                addFileToList(file);
            });
        };
        
        input.click();
    }
    
    function addFileToList(file) {
        const filesList = document.getElementById('files-list');
        if (!filesList) return;
        
        // Сначала загружаем файл на сервер
        uploadFileToServer(file);
    }
    
    async function uploadFileToServer(file) {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('Токен не найден');
                return;
            }
            
            const formData = new FormData();
            formData.append('drawing', file);
            
            const response = await fetch(`/api/orders/${activeCardId}/drawings`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            
            // После успешной загрузки добавляем файл в список
            addFileToDrawingsList({
                id: result.drawing.id,
                original_name: result.drawing.file_name,
                filename: result.drawing.file_name,
                size: result.drawing.file_size
            });
            
        } catch (error) {
            console.error('Ошибка загрузки файла:', error);
            alert('Ошибка при загрузке файла. Попробуйте еще раз.');
        }
    }
    
    async function deleteFile(button) {
        const fileItem = button.closest('.file-download');
        if (!fileItem) return;
        
        // Получаем ID файла из кнопки удаления
        const deleteBtn = fileItem.querySelector('.delete-btn');
        const fileId = deleteBtn.getAttribute('data-file-id');
        
        if (fileId && !fileId.startsWith('new-')) {
            // Удаляем файл с сервера
            await deleteFileFromOrder(fileId, button);
        } else {
            // Удаляем только из UI
            fileItem.remove();
        }
    }
    
    // Функции для работы с комментариями
    function addNewComment() {
        const commentText = prompt('Введите комментарий:');
        if (commentText && commentText.trim()) {
            addCommentToList(commentText, 'Текущий пользователь');
        }
    }
    
    function addCommentToList(text, author) {
        const commentsList = document.getElementById('comments-list');
        if (!commentsList) return;
        
        const commentItem = document.createElement('div');
        commentItem.className = 'comment';
        
        const now = new Date();
        const timeString = now.toLocaleDateString('ru-RU') + ' ' + now.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
        
        commentItem.innerHTML = `
            <div class="comment-header">
                <span class="comment-author">${author}</span>
                <span class="comment-time">${timeString}</span>
            </div>
            <div class="comment-text">${text}</div>
        `;
        
        commentsList.appendChild(commentItem);
    }
    
    // Функции для работы с материалами
    function addNewMaterial() {
        const name = prompt('Введите наименование материала:');
        if (name && name.trim()) {
            const quantity = prompt('Введите количество:');
            if (quantity && quantity.trim()) {
                addMaterialToList(name.trim(), quantity.trim());
            }
        }
    }
    
    function addMaterialToList(name, quantity) {
        const tableBody = document.getElementById('materials-table-body');
        if (!tableBody) return;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${name}</td>
            <td>${quantity}</td>
            <td class="actions-cell">
                <button class="edit-material-btn" onclick="editMaterial(this)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </button>
                <button class="delete-material-btn" onclick="deleteMaterial(this)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3,6 5,6 21,6"></polyline>
                        <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                </button>
            </td>
        `;
        
        tableBody.appendChild(row);
    }
    
    function editMaterial(button) {
        const row = button.closest('tr');
        const nameCell = row.cells[0];
        const quantityCell = row.cells[1];
        
        const currentName = nameCell.textContent;
        const currentQuantity = quantityCell.textContent;
        
        const newName = prompt('Наименование материала:', currentName);
        if (newName !== null) {
            const newQuantity = prompt('Количество:', currentQuantity);
            if (newQuantity !== null) {
                nameCell.textContent = newName;
                quantityCell.textContent = newQuantity;
            }
        }
    }
    
    function deleteMaterial(button) {
        if (confirm('Удалить этот материал?')) {
            const row = button.closest('tr');
            row.remove();
        }
    }
    
    // Функции для работы с финансовыми данными
    function saveFinanceData() {
        const paymentMethodDisplay = document.getElementById('payment-method-display');
        const paymentMethodInput = document.getElementById('payment-method-input');
        const prepaymentDateDisplay = document.getElementById('prepayment-date-display');
        const prepaymentDateInput = document.getElementById('prepayment-date-input');
        const invoiceNumberDisplay = document.getElementById('invoice-number-display');
        const invoiceNumberInput = document.getElementById('invoice-number-input');
        const finalPaymentDateDisplay = document.getElementById('final-payment-date-display');
        const finalPaymentDateInput = document.getElementById('final-payment-date-input');
        const paymentCommentDisplay = document.getElementById('payment-comment-display');
        const paymentCommentInput = document.getElementById('payment-comment-input');
        
        // Сохраняем значения
        if (paymentMethodDisplay && paymentMethodInput) {
            const selectedOption = paymentMethodInput.options[paymentMethodInput.selectedIndex];
            paymentMethodDisplay.textContent = selectedOption.text;
        }
        if (prepaymentDateDisplay && prepaymentDateInput) {
            const date = new Date(prepaymentDateInput.value);
            prepaymentDateDisplay.textContent = date.toLocaleDateString('ru-RU');
        }
        if (invoiceNumberDisplay && invoiceNumberInput) {
            invoiceNumberDisplay.textContent = invoiceNumberInput.value;
        }
        if (finalPaymentDateDisplay && finalPaymentDateInput) {
            if (finalPaymentDateInput.value) {
                const date = new Date(finalPaymentDateInput.value);
                finalPaymentDateDisplay.textContent = date.toLocaleDateString('ru-RU');
            } else {
                finalPaymentDateDisplay.textContent = 'Не установлена';
            }
        }
        if (paymentCommentDisplay && paymentCommentInput) {
            paymentCommentDisplay.textContent = paymentCommentInput.value;
        }
        
        // Выходим из режима редактирования
        toggleEditMode('finance-section');
        
        // Обновляем данные в карточке
        updateCardFinanceData();
        
        console.log('Финансовые данные сохранены');
    }
    
    
    // Функция для обновления финансовых данных в карточке
    function updateCardFinanceData() {
        if (activeCardId) {
            const activeCard = document.querySelector(`[data-card-id="${activeCardId}"]`);
            if (activeCard) {
                // Обновляем сумму в карточке
                const amountElement = activeCard.querySelector('.card-amount');
                const prepaymentElement = activeCard.querySelector('.prepayment');
                
                if (amountElement) {
                    const totalAmount = document.getElementById('finance-total-amount');
                    if (totalAmount) {
                        amountElement.textContent = totalAmount.textContent;
                        // Обновляем data-атрибут для правильного подсчета сумм колонок
                        const amountValue = totalAmount.textContent.replace(/[^\d]/g, '');
                        activeCard.setAttribute('data-card-amount', amountValue);
                    }
                }
                
                if (prepaymentElement) {
                    const prepaymentAmount = document.getElementById('finance-prepayment');
                    if (prepaymentAmount) {
                        prepaymentElement.textContent = 'Предоплата: ' + prepaymentAmount.textContent;
                    }
                }
                
                // Обновляем данные в детальной панели
                const detailAmount = document.getElementById('detail-amount');
                const detailPrepayment = document.getElementById('detail-prepayment');
                
                if (detailAmount && amountElement) {
                    detailAmount.textContent = amountElement.textContent;
                }
                if (detailPrepayment && prepaymentElement) {
                    detailPrepayment.textContent = prepaymentElement.textContent.replace('Предоплата: ', '');
                }
                
                // Пересчитываем суммы колонок
                updateColumnSums();
            }
        }
    }
    
    // Функции для работы с контактными данными
    function saveContactsData() {
        const nameDisplay = document.getElementById('client-name-display');
        const nameInput = document.getElementById('client-name-input');
        const phoneDisplay = document.getElementById('client-phone-display');
        const phoneInput = document.getElementById('client-phone-input');
        const emailDisplay = document.getElementById('client-email-display');
        const emailInput = document.getElementById('client-email-input');
        const additionalDisplay = document.getElementById('client-additional-display');
        const additionalInput = document.getElementById('client-additional-input');
        const preferredDisplay = document.getElementById('client-preferred-display');
        const preferredInput = document.getElementById('client-preferred-input');
        
        // Сохраняем значения
        if (nameDisplay && nameInput) {
            nameDisplay.textContent = nameInput.value;
        }
        if (phoneDisplay && phoneInput) {
            phoneDisplay.textContent = phoneInput.value;
        }
        if (emailDisplay && emailInput) {
            emailDisplay.textContent = emailInput.value;
        }
        if (additionalDisplay && additionalInput) {
            additionalDisplay.textContent = additionalInput.value;
        }
        if (preferredDisplay && preferredInput) {
            const selectedOption = preferredInput.options[preferredInput.selectedIndex];
            preferredDisplay.textContent = selectedOption.text;
        }
        
        // Выходим из режима редактирования
        toggleEditMode('contacts-section');
        
        // Обновляем данные в основной карточке
        updateCardClientData(nameInput.value);
        
        console.log('Контактные данные сохранены');
    }
    
    // Функции для работы с данными доставки
    function saveDeliveryData() {
        const addressDisplay = document.getElementById('delivery-address-display');
        const addressInput = document.getElementById('delivery-address-input');
        const dateDisplay = document.getElementById('delivery-date-display');
        const dateInput = document.getElementById('delivery-date-input');
        const timeDisplay = document.getElementById('delivery-time-display');
        const timeInput = document.getElementById('delivery-time-input');
        const methodDisplay = document.getElementById('delivery-method-display');
        const methodInput = document.getElementById('delivery-method-input');
        const costDisplay = document.getElementById('delivery-cost-display');
        const costInput = document.getElementById('delivery-cost-input');
        const commentDisplay = document.getElementById('delivery-comment-display');
        const commentInput = document.getElementById('delivery-comment-input');
        
        // Сохраняем значения
        if (addressDisplay && addressInput) {
            addressDisplay.textContent = addressInput.value;
        }
        if (dateDisplay && dateInput) {
            const date = new Date(dateInput.value);
            dateDisplay.textContent = date.toLocaleDateString('ru-RU');
        }
        if (timeDisplay && timeInput) {
            const selectedOption = timeInput.options[timeInput.selectedIndex];
            timeDisplay.textContent = selectedOption.text;
        }
        if (methodDisplay && methodInput) {
            const selectedOption = methodInput.options[methodInput.selectedIndex];
            methodDisplay.textContent = selectedOption.text;
        }
        if (costDisplay && costInput) {
            costDisplay.textContent = costInput.value + ' ₽';
        }
        if (commentDisplay && commentInput) {
            commentDisplay.textContent = commentInput.value;
        }
        
        // Выходим из режима редактирования
        toggleEditMode('delivery-section');
        
        console.log('Данные доставки сохранены');
    }
    
    // Функция для обновления данных клиента в карточке
    function updateCardClientData(clientName) {
        // Находим активную карточку по сохраненному ID
        if (activeCardId) {
            const activeCard = document.querySelector(`[data-card-id="${activeCardId}"]`);
            if (activeCard) {
                const clientNameElement = activeCard.querySelector('.client-name');
                if (clientNameElement) {
                    clientNameElement.textContent = clientName;
                }
                
                // Обновляем аватар (первые буквы имени)
                const avatarElement = activeCard.querySelector('.client-avatar');
                if (avatarElement) {
                    const initials = clientName.split(' ').map(word => word[0]).join('').toUpperCase();
                    avatarElement.textContent = initials;
                }
                
                // Обновляем данные в детальной панели
                const detailClientName = document.getElementById('detail-client-name');
                const detailAvatar = document.getElementById('detail-avatar');
                
                if (detailClientName) {
                    detailClientName.textContent = clientName;
                }
                if (detailAvatar) {
                    detailAvatar.textContent = initials;
                }
            }
        }
    }
    
    // Функции для работы с платежами
    function addNewPayment() {
        const amount = prompt('Введите сумму платежа:');
        if (amount && amount.trim()) {
            const type = prompt('Тип платежа (Предоплата, Окончательный платеж, Дополнительный):', 'Предоплата');
            if (type && type.trim()) {
                const method = prompt('Способ оплаты:', 'Банковский перевод');
                if (method && method.trim()) {
                    addPaymentToList(amount.trim(), type.trim(), method.trim());
                }
            }
        }
    }
    
    function addPaymentToList(amount, type, method) {
        const paymentsList = document.getElementById('payments-list');
        if (!paymentsList) return;
        
        const paymentItem = document.createElement('div');
        paymentItem.className = 'payment-item';
        
        const now = new Date();
        const dateString = now.toLocaleDateString('ru-RU');
        
        paymentItem.innerHTML = `
            <div class="payment-info">
                <div class="payment-amount">${amount} ₽</div>
                <div class="payment-type">${type}</div>
            </div>
            <div class="payment-details">
                <div class="payment-date">${dateString}</div>
                <div class="payment-method">${method}</div>
            </div>
            <div class="payment-actions">
                <button class="edit-payment-btn" onclick="editPayment(this)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </button>
                <button class="delete-payment-btn" onclick="deletePayment(this)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3,6 5,6 21,6"></polyline>
                        <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                </button>
            </div>
        `;
        
        paymentsList.appendChild(paymentItem);
    }
    
    function editPayment(button) {
        const paymentItem = button.closest('.payment-item');
        const amountElement = paymentItem.querySelector('.payment-amount');
        const typeElement = paymentItem.querySelector('.payment-type');
        const methodElement = paymentItem.querySelector('.payment-method');
        
        const currentAmount = amountElement.textContent.replace(' ₽', '');
        const currentType = typeElement.textContent;
        const currentMethod = methodElement.textContent;
        
        const newAmount = prompt('Сумма платежа:', currentAmount);
        if (newAmount !== null) {
            const newType = prompt('Тип платежа:', currentType);
            if (newType !== null) {
                const newMethod = prompt('Способ оплаты:', currentMethod);
                if (newMethod !== null) {
                    amountElement.textContent = newAmount + ' ₽';
                    typeElement.textContent = newType;
                    methodElement.textContent = newMethod;
                }
            }
        }
    }
    
    function deletePayment(button) {
        if (confirm('Удалить этот платеж?')) {
            const paymentItem = button.closest('.payment-item');
            paymentItem.remove();
        }
    }
    
    // Функции для перетаскивания карточек
    function initColumnDragAndDrop(column) {
        // Удаляем старые обработчики, если они есть
        column.removeEventListener('dragover', handleDragOver);
        column.removeEventListener('dragleave', handleDragLeave);
        column.removeEventListener('drop', handleDrop);
        
        // Добавляем новые обработчики
        column.addEventListener('dragover', handleDragOver);
        column.addEventListener('dragleave', handleDragLeave);
        column.addEventListener('drop', handleDrop);
    }
    
    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('drop-area');
    }
    
    function handleDragLeave(e) {
        // Проверяем, что мы действительно покинули колонку, а не перешли к дочернему элементу
        if (!this.contains(e.relatedTarget)) {
            this.classList.remove('drop-area');
        }
    }
    
    
    // Глобальная переменная для перетаскиваемой карточки
    let draggedCard = null;
    
    // Глобальная функция для инициализации drag & drop
    function initializeDragAndDrop() {
        console.log('Initializing drag and drop...');
        const cards = document.querySelectorAll('.kanban-card');
        console.log('Found cards:', cards.length);
        // alert('Drag & drop initialized! Found ' + cards.length + ' cards'); // Временный тест
        const columns = document.querySelectorAll('.kanban-column');
        
        console.log('Found cards:', cards.length);
        console.log('Found columns:', columns.length);
        
        // Удаляем старые обработчики
        cards.forEach(card => {
            card.removeEventListener('dragstart', handleCardDragStart);
            card.removeEventListener('dragend', handleCardDragEnd);
        });
        
        // Добавляем новые обработчики для карточек
        cards.forEach(card => {
            card.addEventListener('dragstart', handleCardDragStart);
            card.addEventListener('dragend', handleCardDragEnd);
            console.log('Added drag handlers to card:', card.dataset.cardId);
        });
        
        // Удаляем старые обработчики для колонок
        columns.forEach(column => {
            column.removeEventListener('dragover', handleDragOver);
            column.removeEventListener('dragleave', handleDragLeave);
            column.removeEventListener('drop', handleDrop);
        });
        
        // Добавляем обработчики для колонок
        columns.forEach(column => {
            column.addEventListener('dragover', handleDragOver);
            column.addEventListener('dragleave', handleDragLeave);
            column.addEventListener('drop', handleDrop);
            console.log('Added drop handlers to column:', column.dataset.columnId);
        });
        
        console.log('Drag and drop initialized successfully');
    }
    
    // Обработчики событий drag & drop
    function handleCardDragStart(e) {
        console.log('Card drag start:', this.dataset.cardId);
        draggedCard = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', this.dataset.cardId);
        console.log('Drag data set:', this.dataset.cardId);
    }
    
    function handleCardDragEnd() {
        console.log('Card drag end');
        this.classList.remove('dragging');
        const columns = document.querySelectorAll('.kanban-column');
        columns.forEach(col => col.classList.remove('drop-area'));
        // Не очищаем draggedCard здесь, так как он используется в handleDrop
    }
    
    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('drop-area');
        console.log('Drag over column:', this.dataset.columnId);
    }
    
    function handleDragLeave(e) {
        if (!this.contains(e.relatedTarget)) {
            this.classList.remove('drop-area');
            console.log('Drag leave column:', this.dataset.columnId);
        }
    }
    
    function handleDrop(e) {
        e.preventDefault();
        this.classList.remove('drop-area');
        console.log('Drop on column:', this.dataset.columnId);
        
        const cardId = e.dataTransfer.getData('text/plain');
        const draggedCardElement = document.querySelector(`[data-card-id="${cardId}"]`);
        
        if (draggedCardElement) {
            const cardsContainer = this.querySelector('.kanban-cards');
            if (cardsContainer) {
                console.log('Moving card from', draggedCardElement.parentNode.dataset.columnId, 'to', this.dataset.columnId);
                cardsContainer.appendChild(draggedCardElement);
                
                // Обновляем счетчики карточек и суммы
                updateColumnCounts();
                updateColumnSums();
                
                // Синхронизируем с сервером
                updateProductionStageOnServer(cardId, this.dataset.columnId);
            }
        }
        
        // Очищаем глобальную переменную
        draggedCard = null;
    }
    
    
    // Функция для обновления этапа производства на сервере
    async function updateProductionStageOnServer(orderId, columnId) {
        try {
            const columnTitles = {
                '1': 'КБ',
                '2': 'Столярный цех', 
                '3': 'Формовка',
                '4': 'Швейный цех',
                '5': 'Обивка',
                '6': 'Сборка и упаковка',
                '7': 'Отгружен'
            };
            
            const stage = columnTitles[columnId];
            if (!stage) {
                console.error('Неизвестный этап производства:', columnId);
                return;
            }
            
            const token = localStorage.getItem('token') || 'test-token';
            
            const response = await fetch(`http://localhost:5000/api/orders/kanban/${orderId}/stage`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ stage: stage })
            });
            
            if (response.ok) {
                console.log(`✅ Этап производства обновлен: ${stage}`);
            } else {
                const errorData = await response.json();
                console.error('❌ Ошибка обновления этапа:', errorData.message);
            }
        } catch (error) {
            console.error('❌ Ошибка синхронизации с сервером:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded - Starting initialization...');
        
        // Проверяем сохраненную тему при загрузке
        const savedTheme = localStorage.getItem('theme');
        const themeText = themeToggle.querySelector('span');
        
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-theme');
            themeText.textContent = 'Светлая тема';
        } else {
            themeText.textContent = 'Темная тема';
        }
        
        // Устанавливаем токен для API запросов
        if (!localStorage.getItem('token')) {
            localStorage.setItem('token', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEsImVtYWlsIjoiYWRtaW5Ac29mYW55LmNvbSIsInJvbGUiOiJhZG1pbiIsImlhdCI6MTc1NzQ0NzgwMywiZXhwIjoxNzU4MDUyNjAzfQ.gY1wllkXYWiNiSQq6DF2OYc0bw0Spn4Aw7-2jnswegI');
            console.log('Токен установлен для API запросов');
        }
        
        // Загружаем данные канбана с сервера
        console.log('Loading kanban data from server...');
        loadKanbanData();
        
        // Слушаем события обновления заказов
        window.addEventListener('kanbanOrderUpdated', (event) => {
            console.log('🔄 Получено событие обновления заказа:', event.detail);
            loadKanbanData();
        });
        
        // Инициализируем drag & drop при загрузке с задержкой
        setTimeout(() => {
            console.log('Initializing drag & drop...');
            initializeDragAndDrop();
        }, 100);
        
        // Автоматическое обновление отключено для предотвращения самопроизвольных перестановок карточек
        // setInterval(() => {
        //     console.log('🔄 Автоматическое обновление данных канбана...');
        //     loadKanbanData();
        // }, 30000);
        
        
        // Инициализируем табы
        console.log('Initializing tabs...');
        initTabs();
        
        // Инициализируем суммы колонок
        console.log('Updating column sums and counts...');
        updateColumnSums();
        updateColumnCounts();
        
        // Переинициализируем drag & drop при добавлении новых карточек
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    // Проверяем, добавились ли новые карточки
                    const newCards = Array.from(mutation.addedNodes).filter(node => 
                        node.nodeType === 1 && node.classList && node.classList.contains('kanban-card')
                    );
                    if (newCards.length > 0) {
                        initializeDragAndDrop();
                    }
                }
            });
        });
        
        // Наблюдаем за изменениями в канбан-доске
        const kanbanBoard = document.getElementById('kanban-board');
        if (kanbanBoard) {
            observer.observe(kanbanBoard, { childList: true, subtree: true });
        }
        
        // Обработчик клавиши Escape для закрытия панели
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeDetailPanel();
            }
        });
    });
    
    // Функция для обновления счетчиков карточек в колонках
    function updateColumnCounts() {
        const columns = document.querySelectorAll('.kanban-column');
        
        columns.forEach(column => {
            const cardsCount = column.querySelectorAll('.kanban-card').length;
            const countElement = column.querySelector('.column-count');
            
            if (countElement) {
                countElement.textContent = cardsCount;
            }
        });
    }
    
    // Переключение темы
    const themeToggle = document.getElementById('theme-toggle');
    themeToggle.addEventListener('click', function() {
        document.body.classList.toggle('dark-theme');
        
        // Меняем текст кнопки
        const themeText = themeToggle.querySelector('span');
        if (document.body.classList.contains('dark-theme')) {
            themeText.textContent = 'Светлая тема';
        } else {
            themeText.textContent = 'Темная тема';
        }
        
        // Сохраняем настройку темы в localStorage
        localStorage.setItem('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
    });
    
    // Функция для загрузки данных канбана с сервера
    async function loadKanbanData() {
        try {
            // Получаем токен из URL параметра, localStorage или используем тестовый
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get('token');
            const token = urlToken || localStorage.getItem('token') || 'test-token';
            
            console.log('🔑 Используемый токен:', token ? 'Найден' : 'Не найден');
            
            const response = await fetch('http://localhost:5000/api/orders/kanban', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('Данные канбана загружены:', data);
            
            // Отладочная информация для предоплаты
            if (data.columns && data.columns.length > 0) {
                data.columns.forEach((column, index) => {
                    if (column.cards && column.cards.length > 0) {
                        console.log(`📊 Колонка ${index + 1} (${column.title}):`);
                        column.cards.forEach((card, cardIndex) => {
                            console.log(`  Карточка ${cardIndex + 1}: ${card.order_number} - Предоплата: ${card.prepayment} ₽`);
                        });
                    }
                });
            }
            
            // Очищаем существующие карточки
            document.querySelectorAll('.kanban-cards').forEach(container => {
                container.innerHTML = '';
            });
            
            // Заполняем колонки данными
            console.log('Заполняем колонки данными...');
            data.columns.forEach(column => {
                console.log(`Обрабатываем колонку ${column.id}: ${column.title}, карточек: ${column.cards.length}`);
                const columnElement = document.querySelector(`[data-column-id="${column.id}"]`);
                if (columnElement) {
                    const cardsContainer = columnElement.querySelector('.kanban-cards');
                    if (cardsContainer) {
                        column.cards.forEach(card => {
                            console.log(`Создаем карточку для заказа ${card.order_number}`);
                            const cardElement = createCardElement(card);
                            cardsContainer.appendChild(cardElement);
                        });
                    } else {
                        console.error(`Не найден контейнер карточек для колонки ${column.id}`);
                    }
                } else {
                    console.error(`Не найдена колонка с ID ${column.id}`);
                }
            });
            
            // Обновляем суммы колонок
            updateColumnSums();
            updateColumnCounts();
            
            // Инициализируем drag & drop для новых карточек
            initializeDragAndDrop();
            
        } catch (error) {
            console.error('Ошибка загрузки данных канбана:', error);
            
            // Загружаем тестовые данные в случае ошибки
            console.log('Загружаем тестовые данные...');
            loadTestData();
        }
    }
    
    // Функция для загрузки тестовых данных
    function loadTestData() {
        const testData = {
            columns: [
                { id: 1, title: 'КБ', cards: [] },
                { id: 2, title: 'Столярный цех', cards: [] },
                { id: 3, title: 'Формовка', cards: [] },
                { id: 4, title: 'Швейный цех', cards: [] },
                { id: 5, title: 'Обивка', cards: [] },
                { id: 6, title: 'Сборка и упаковка', cards: [] },
                { id: 7, title: 'Отгружен', cards: [] }
            ]
        };
        
        // Добавляем тестовые карточки
        testData.columns[1].cards = [
            {
                id: 1,
                order_number: 'ORD-001',
                client: 'Иван Петров',
                product: 'Диван "Комфорт"',
                amount: 50000,
                price: 50000,
                prepayment: 15000,
                priority: 'Высокий',
                created_at: new Date().toISOString(),
                production_stage: 'Столярный цех'
            },
            {
                id: 2,
                order_number: 'ORD-002', 
                client: 'Мария Сидорова',
                product: 'Кресло "Уют"',
                amount: 35000,
                price: 35000,
                prepayment: 10000,
                priority: 'Средний',
                created_at: new Date().toISOString(),
                production_stage: 'Столярный цех'
            }
        ];
        
        testData.columns[3].cards = [
            {
                id: 3,
                order_number: 'ORD-003',
                client: 'Алексей Козлов',
                product: 'Стол "Рабочий"',
                amount: 25000,
                price: 25000,
                prepayment: 7500,
                priority: 'Низкий',
                created_at: new Date().toISOString(),
                production_stage: 'Швейный цех'
            }
        ];
        
        // Очищаем существующие карточки
        document.querySelectorAll('.kanban-cards').forEach(container => {
            container.innerHTML = '';
        });
        
        // Заполняем колонки
        testData.columns.forEach(columnData => {
            const columnElement = document.querySelector(`[data-column-id="${columnData.id}"]`);
            if (columnElement) {
                const cardsContainer = columnElement.querySelector('.kanban-cards');
                if (cardsContainer) {
                    columnData.cards.forEach(cardData => {
                        const cardElement = createCardElement(cardData);
                        cardsContainer.appendChild(cardElement);
                    });
                }
            }
        });
        
        // Обновляем счетчики
        updateColumnCounts();
        console.log('Тестовые данные загружены');
    }
    
    
    // Функции для управления настройками колонок
    let columnOrder = [1, 2, 3, 4, 5, 6, 7]; // Порядок колонок по умолчанию
    let isCompactView = false; // Состояние компактного вида
    
    function openColumnSettings() {
        // Переходим к новому редактору колонок
        window.open('/kanban/settings', '_blank');
    }

    // Функции для управления компактным видом
    function toggleCompactView() {
        isCompactView = !isCompactView;
        const board = document.getElementById('kanban-board');
        const btn = document.getElementById('compact-view-btn');
        const text = document.getElementById('compact-view-text');
        
        if (isCompactView) {
            board.classList.add('compact-view');
            text.textContent = 'Обычный вид';
            btn.classList.add('active');
        } else {
            board.classList.remove('compact-view');
            text.textContent = 'Компактный вид';
            btn.classList.remove('active');
        }
        
        // Сохраняем настройку
        localStorage.setItem('kanban-compact-view', isCompactView);
        
        // Обновляем все карточки
        updateAllCardsView();
    }

    function updateAllCardsView() {
        const cards = document.querySelectorAll('.kanban-card');
        cards.forEach(card => {
            if (isCompactView) {
                card.classList.add('compact');
            } else {
                card.classList.remove('compact');
            }
        });
    }

    function loadCompactViewSetting() {
        const saved = localStorage.getItem('kanban-compact-view');
        if (saved === 'true') {
            isCompactView = true;
            const board = document.getElementById('kanban-board');
            const btn = document.getElementById('compact-view-btn');
            const text = document.getElementById('compact-view-text');
            
            board.classList.add('compact-view');
            text.textContent = 'Обычный вид';
            btn.classList.add('active');
        }
    }
    
    // Функция для создания элемента карточки
    function createCardElement(card) {
        // Отладочная информация для предоплаты
        console.log(`🔍 Создание карточки ${card.order_number}:`, {
            prepayment: card.prepayment,
            price: card.price,
            client: card.client
        });
        
        const cardElement = document.createElement('div');
        cardElement.className = 'kanban-card';
        if (isCompactView) {
            cardElement.classList.add('compact');
        }
        cardElement.draggable = true;
        cardElement.setAttribute('data-card-id', card.id);
        cardElement.setAttribute('data-card-amount', card.price);
        cardElement.onclick = () => openDetailPanel(cardElement);
        
        cardElement.innerHTML = `
            <div class="card-header">
                <div class="card-amount">${card.price.toLocaleString('ru-RU')} ₽</div>
                <div class="card-deadline">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 3px;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12,6 12,12 16,14"></polyline>
                    </svg>
                    ${card.deadline ? new Date(card.deadline).toLocaleDateString('ru-RU') : '31.01.2024'}
                </div>
            </div>
            <h3 class="card-title">${card.short_description || card.product_name || 'Без названия'}</h3>
            <div class="production-status" style="display: none;">В пошиве</div>
            <div class="card-header-info">
                <div class="card-order-number">
                    <div class="order-number-frame">${getShortOrderNumber(card.order_number)}</div>
                    <div class="status-circle priority-${card.priority || 'medium'}">${getStatusLetter(card.priority)}</div>
                </div>
                <div class="prepayment">${(card.prepayment || 0).toLocaleString('ru-RU')} ₽</div>
            </div>
            
            <div class="card-footer">
                <div class="client-avatar">${getClientInitials(card.client)}</div>
                <div class="client-name">${card.client || 'Не указан'}</div>
            </div>
            
            <!-- Дополнительные поля для отображения в карточке -->
            ${card.additional_contact ? `<div class="card-contact">📞 ${card.additional_contact}</div>` : ''}
        `;
        
        return cardElement;
    }
    
    // Функция для загрузки полных данных заказа
    async function loadOrderDetails(orderId) {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('Токен не найден');
                return;
            }
            
            const response = await fetch(`/api/orders/${orderId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            const order = data.order;
            
            // Заполняем краткое описание
            const shortDescDisplayEl = document.getElementById('short-description-display');
            const shortDescInputEl = document.getElementById('short-description-input');
            
            if (shortDescDisplayEl && shortDescInputEl) {
                const shortDesc = order.short_description || order.product_name || '';
                shortDescDisplayEl.textContent = shortDesc || 'Краткое описание не указано';
                shortDescInputEl.value = shortDesc;
            }
            
            // Заполняем подробное описание
            const detailedDescDisplayEl = document.getElementById('detailed-description-display');
            const detailedDescInputEl = document.getElementById('detailed-description-input');
            
            if (detailedDescDisplayEl && detailedDescInputEl) {
                const detailedDesc = order.detailed_description || order.project_description || '';
                detailedDescDisplayEl.textContent = detailedDesc || 'Подробное описание не указано';
                detailedDescInputEl.value = detailedDesc;
            }
            
            // Заполняем основные поля заказа
            const amountDisplayEl = document.getElementById('amount-display');
            const amountInputEl = document.getElementById('amount-input');
            const prepaymentDisplayEl = document.getElementById('prepayment-display');
            const prepaymentInputEl = document.getElementById('prepayment-input');
            
            if (amountDisplayEl && amountInputEl) {
                const amount = order.total_amount || 0;
                amountDisplayEl.textContent = amount.toLocaleString('ru-RU') + ' ₽';
                amountInputEl.value = amount;
            }
            
            if (prepaymentDisplayEl && prepaymentInputEl) {
                const prepayment = order.prepayment_amount || 0;
                prepaymentDisplayEl.textContent = prepayment.toLocaleString('ru-RU') + ' ₽';
                prepaymentInputEl.value = prepayment;
            }
            
            // Заполняем дополнительные поля клиента
            const clientPhoneEl = document.getElementById('client-phone-display');
            const clientEmailEl = document.getElementById('client-email-display');
            const clientCompanyEl = document.getElementById('client-company-display');
            
            if (clientPhoneEl) clientPhoneEl.textContent = order.customer_phone || 'Телефон не указан';
            if (clientEmailEl) clientEmailEl.textContent = order.customer_email || 'Email не указан';
            if (clientCompanyEl) clientCompanyEl.textContent = order.customer_company || 'Компания не указана';
            
            // Заполняем поля доставки
            const deliveryAddressEl = document.getElementById('delivery-address-display');
            const deliveryDateEl = document.getElementById('delivery-date-display');
            const hasElevatorEl = document.getElementById('delivery-elevator-display');
            const floorEl = document.getElementById('delivery-floor-display');
            
            if (deliveryAddressEl) deliveryAddressEl.textContent = order.delivery_address || 'Адрес не указан';
            if (deliveryDateEl) deliveryDateEl.textContent = order.delivery_date ? new Date(order.delivery_date).toLocaleDateString('ru-RU') : 'Дата не указана';
            if (hasElevatorEl) hasElevatorEl.textContent = order.has_elevator ? 'Есть лифт' : 'Нет лифта';
            if (floorEl) floorEl.textContent = order.floor || 'Этаж не указан';
            
            // Заполняем дополнительные контакты
            const additionalContactEl = document.getElementById('client-additional-display');
            const preferredContactEl = document.getElementById('client-preferred-display');
            
            if (additionalContactEl) additionalContactEl.textContent = order.additional_contact || 'Дополнительный контакт не указан';
            if (preferredContactEl) preferredContactEl.textContent = order.preferred_contact || 'Предпочтительный способ связи не указан';
            
            // Загружаем файлы заказа
            await loadOrderFiles(orderId);
            
        } catch (error) {
            console.error('Ошибка загрузки данных заказа:', error);
        }
    }
    
    // Функция для загрузки файлов заказа
    async function loadOrderFiles(orderId) {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('Токен не найден');
                return;
            }
            
            const response = await fetch(`/api/orders/${orderId}/drawings`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            const files = data.files || [];
            
            // Очищаем список файлов
            const filesList = document.getElementById('files-list');
            if (filesList) {
                filesList.innerHTML = '';
                
                // Добавляем файлы в список
                files.forEach(file => {
                    addFileToDrawingsList(file);
                });
            }
            
        } catch (error) {
            console.error('Ошибка загрузки файлов заказа:', error);
        }
    }
    
    // Функция для добавления файла в список чертежей
    function addFileToDrawingsList(file) {
        const filesList = document.getElementById('files-list');
        if (!filesList) return;
        
        const fileItem = document.createElement('div');
        fileItem.className = 'file-download';
        
        const fileSize = file.size ? (file.size / 1024 / 1024).toFixed(1) + ' МБ' : 'Неизвестно';
        
        fileItem.innerHTML = `
            <div class="file-info">
                <div class="file-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14,2 14,8 20,8"></polyline>
                    </svg>
                </div>
                <div>
                    <div class="file-name">${file.original_name || file.filename || 'Файл'}</div>
                    <div class="file-size">${fileSize}</div>
                </div>
            </div>
            <div class="file-actions">
                <button class="download-btn" onclick="downloadFile('${file.id}', '${file.original_name || file.filename}')">Скачать</button>
                <button class="delete-btn" data-file-id="${file.id}" onclick="deleteFile(this)">×</button>
            </div>
        `;
        
        filesList.appendChild(fileItem);
    }
    
    // Функция для скачивания файла
    async function downloadFile(fileId, fileName) {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('Токен не найден');
                return;
            }
            
            const response = await fetch(`/api/orders/${activeCardId}/drawings/${fileId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            // Создаем blob и скачиваем файл
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
        } catch (error) {
            console.error('Ошибка скачивания файла:', error);
            alert('Ошибка при скачивании файла. Попробуйте еще раз.');
        }
    }
    
    // Функция для удаления файла из заказа
    async function deleteFileFromOrder(fileId, button) {
        if (!confirm('Вы уверены, что хотите удалить этот файл?')) {
            return;
        }
        
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('Токен не найден');
                return;
            }
            
            const response = await fetch(`/api/orders/${activeCardId}/drawings/${fileId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            // Удаляем элемент из списка
            const fileItem = button.closest('.file-download');
            if (fileItem) {
                fileItem.remove();
            }
            
        } catch (error) {
            console.error('Ошибка удаления файла:', error);
            alert('Ошибка при удалении файла. Попробуйте еще раз.');
        }
    }
    
    // Функция для сохранения краткого описания
    async function saveShortDescription() {
        const shortDescInput = document.getElementById('short-description-input');
        const shortDescDisplay = document.getElementById('short-description-display');
        
        if (!shortDescInput || !activeCardId) {
            console.error('Не найдены элементы для сохранения краткого описания');
            return;
        }
        
        const newShortDesc = shortDescInput.value.trim();
        
        try {
            // Обновляем отображение
            if (shortDescDisplay) {
                shortDescDisplay.textContent = newShortDesc || 'Краткое описание не указано';
            }
            
            // Отправляем на сервер
            const token = localStorage.getItem('token');
            if (token) {
                const response = await fetch(`http://localhost:5000/api/orders/${activeCardId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ short_description: newShortDesc })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Обновляем карточку в канбане
                updateCardShortDescription(activeCardId, newShortDesc);
            }
            
            // Выходим из режима редактирования
            toggleEditMode('short-description');
            
        } catch (error) {
            console.error('Ошибка при сохранении краткого описания:', error);
            alert('Ошибка при сохранении краткого описания. Попробуйте еще раз.');
        }
    }
    
    // Функция для сохранения подробного описания
    async function saveDetailedDescription() {
        const detailedDescInput = document.getElementById('detailed-description-input');
        const detailedDescDisplay = document.getElementById('detailed-description-display');
        
        if (!detailedDescInput || !activeCardId) {
            console.error('Не найдены элементы для сохранения подробного описания');
            return;
        }
        
        const newDetailedDesc = detailedDescInput.value.trim();
        
        try {
            // Обновляем отображение
            if (detailedDescDisplay) {
                detailedDescDisplay.textContent = newDetailedDesc || 'Подробное описание не указано';
            }
            
            // Отправляем на сервер
            const token = localStorage.getItem('token');
            if (token) {
                const response = await fetch(`http://localhost:5000/api/orders/${activeCardId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ detailed_description: newDetailedDesc })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            }
            
            // Выходим из режима редактирования
            toggleEditMode('detailed-description');
            
        } catch (error) {
            console.error('Ошибка при сохранении подробного описания:', error);
            alert('Ошибка при сохранении подробного описания. Попробуйте еще раз.');
        }
    }
    
    // Функция для обновления краткого описания в карточке канбана
    function updateCardShortDescription(orderId, shortDescription) {
        const card = document.querySelector(`[data-card-id="${orderId}"]`);
        if (!card) return;
        
        const titleEl = card.querySelector('.card-title');
        if (titleEl && shortDescription) {
            titleEl.textContent = shortDescription;
        }
    }
    
    // Вспомогательные функции
    function getPriorityText(priority) {
        switch (priority) {
            case 'high': return 'Высокий';
            case 'medium': return 'Средний';
            case 'low': return 'Низкий';
            default: return 'Средний';
        }
    }
    
    // Функция для получения короткого номера заказа
    function getShortOrderNumber(orderNumber) {
        if (!orderNumber) return '?';
        // Возвращаем полный номер заказа
        return orderNumber;
    }
    
    // Функция для получения буквы приоритета
    function getStatusLetter(priority) {
        if (!priority) return '?';
        const priorityMap = {
            'high': 'В',
            'medium': 'С',
            'normal': 'С',  // Добавляем поддержку "normal" как "medium"
            'low': 'Н'
        };
        return priorityMap[priority] || '?';
    }

    function getPriorityMarker(priority) {
        switch (priority) {
            case 'high': return 'В';
            case 'medium': return 'О';
            case 'low': return 'Н';
            default: return 'О';
        }
    }

    // Функция для сохранения основной информации
    function saveMainInfo() {
        // Сохраняем статус заказа
        const statusDisplay = document.getElementById('status-display');
        const statusInput = document.getElementById('status-input');
        
        if (statusDisplay && statusInput) {
            const statusText = statusInput.options[statusInput.selectedIndex].text;
            statusDisplay.textContent = statusText;
        }
        
        // Сохраняем приоритет
        const priorityDisplay = document.getElementById('priority-display');
        const priorityInput = document.getElementById('priority-input');
        
        if (priorityDisplay && priorityInput) {
            const priorityText = priorityInput.options[priorityInput.selectedIndex].text;
            priorityDisplay.textContent = priorityText;
            
            // Обновляем маркер в карточке
            if (activeCardId) {
                const activeCard = document.querySelector(`[data-card-id="${activeCardId}"]`);
                if (activeCard) {
                    const statusCircle = activeCard.querySelector('.status-circle');
                    if (statusCircle) {
                        const priorityValue = priorityInput.value;
                        statusCircle.textContent = getStatusLetter(priorityValue);
                        statusCircle.className = `status-circle priority-${priorityValue}`;
                    }
                }
            }
        }
        
        // Сохраняем сумму сделки
        const amountDisplay = document.getElementById('amount-display');
        const amountInput = document.getElementById('amount-input');
        if (amountDisplay && amountInput) {
            amountDisplay.textContent = amountInput.value + ' ₽';
        }
        
        // Сохраняем предоплату
        const prepaymentDisplay = document.getElementById('prepayment-display');
        const prepaymentInput = document.getElementById('prepayment-input');
        if (prepaymentDisplay && prepaymentInput) {
            prepaymentDisplay.textContent = prepaymentInput.value + ' ₽';
        }
        
        // Отправляем изменения на сервер
        if (activeCardId) {
            saveOrderToServer();
        }
        
        // Сохраняем дедлайн
        const deadlineDisplay = document.getElementById('deadline-display');
        const deadlineInput = document.getElementById('deadline-input');
        if (deadlineDisplay && deadlineInput) {
            const date = new Date(deadlineInput.value);
            deadlineDisplay.textContent = date.toLocaleDateString('ru-RU');
            
            // Обновляем дедлайн в карточке канбана
            if (activeCardId) {
                const activeCard = document.querySelector(`[data-card-id="${activeCardId}"]`);
                if (activeCard) {
                    const deadlineEl = activeCard.querySelector('.card-deadline');
                    if (deadlineEl) {
                        deadlineEl.innerHTML = `
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 3px;">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12,6 12,12 16,14"></polyline>
                            </svg>
                            ${date.toLocaleDateString('ru-RU')}
                        `;
                    }
                }
            }
        }
        
        // Выходим из режима редактирования
        toggleEditMode('main-info');
        
        console.log('Основная информация сохранена');
    }
    
    // Функция для сохранения изменений заказа на сервере
    async function saveOrderToServer() {
        if (!activeCardId) {
            console.error('Нет активного заказа для сохранения');
            return;
        }
        
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('Токен не найден');
                return;
            }
            
            // Собираем данные из формы
            const amountInput = document.getElementById('amount-input');
            const prepaymentInput = document.getElementById('prepayment-input');
            const priorityInput = document.getElementById('priority-input');
            const statusInput = document.getElementById('status-input');
            const deadlineInput = document.getElementById('deadline-input');
            
            const updateData = {};
            
            if (amountInput && amountInput.value) {
                updateData.total_amount = parseFloat(amountInput.value);
            }
            
            if (prepaymentInput && prepaymentInput.value) {
                updateData.prepayment_amount = parseFloat(prepaymentInput.value);
            }
            
            if (priorityInput && priorityInput.value) {
                updateData.priority = priorityInput.value;
            }
            
            if (statusInput && statusInput.value) {
                updateData.status = statusInput.value;
            }
            
            if (deadlineInput && deadlineInput.value) {
                updateData.delivery_date = deadlineInput.value;
            }
            
            // Отправляем запрос на сервер
            const response = await fetch(`http://localhost:5000/api/orders/${activeCardId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            console.log('Заказ успешно обновлен:', result);
            
            // Обновляем карточку в канбане
            updateCardInKanban(activeCardId, updateData);
            
        } catch (error) {
            console.error('Ошибка при сохранении заказа:', error);
            alert('Ошибка при сохранении изменений. Попробуйте еще раз.');
        }
    }
    
    // Функция для обновления карточки в канбане
    function updateCardInKanban(orderId, updateData) {
        const card = document.querySelector(`[data-card-id="${orderId}"]`);
        if (!card) return;
        
        // Обновляем сумму в карточке
        if (updateData.total_amount !== undefined) {
            const amountEl = card.querySelector('.card-amount');
            if (amountEl) {
                amountEl.textContent = updateData.total_amount.toLocaleString('ru-RU') + ' ₽';
            }
        }
        
        // Обновляем предоплату в карточке
        if (updateData.prepayment_amount !== undefined) {
            const prepaymentEl = card.querySelector('.prepayment');
            if (prepaymentEl) {
                prepaymentEl.textContent = (updateData.prepayment_amount || 0).toLocaleString('ru-RU') + ' ₽';
            }
        }
        
        // Обновляем приоритет в карточке
        if (updateData.priority !== undefined) {
            const statusCircle = card.querySelector('.status-circle');
            if (statusCircle) {
                statusCircle.textContent = getStatusLetter(updateData.priority);
                statusCircle.className = `status-circle priority-${updateData.priority}`;
            }
        }
        
        // Обновляем дедлайн в карточке
        if (updateData.delivery_date !== undefined) {
            const deadlineEl = card.querySelector('.card-deadline');
            if (deadlineEl) {
                const date = new Date(updateData.delivery_date);
                deadlineEl.innerHTML = `
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 3px;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12,6 12,12 16,14"></polyline>
                    </svg>
                    ${date.toLocaleDateString('ru-RU')}
                `;
            }
        }
    }
    
    // Функция для сохранения приоритета
    async function savePriority() {
        const priorityInput = document.getElementById('priority-input');
        const priorityDisplay = document.getElementById('priority-display');
        const saveButton = document.querySelector('button[onclick="savePriority()"]');
        
        if (!priorityInput || !activeCardId) {
            console.error('Не найдены элементы для сохранения приоритета');
            return;
        }
        
        const newPriority = priorityInput.value;
        const priorityText = priorityInput.options[priorityInput.selectedIndex].text;
        
        try {
            // Обновляем приоритет на сервере
            const token = localStorage.getItem('token') || 'test-token';
            const response = await fetch(`http://localhost:5000/api/orders/${activeCardId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ priority: newPriority })
            });
            
            if (response.ok) {
                // Обновляем отображение
                priorityDisplay.textContent = priorityText;
                priorityDisplay.style.display = 'inline';
                priorityInput.style.display = 'none';
                saveButton.style.display = 'none';
                
                // Обновляем карточку в канбане
                updateCardPriority(activeCardId, newPriority);
                
                console.log('✅ Приоритет обновлен:', priorityText);
            } else {
                const errorData = await response.json();
                console.error('❌ Ошибка обновления приоритета:', errorData.message);
                alert('Ошибка при обновлении приоритета');
            }
        } catch (error) {
            console.error('❌ Ошибка сохранения приоритета:', error);
            alert('Ошибка при сохранении приоритета');
        }
    }
    
    // Функция для обновления приоритета в карточке канбана
    function updateCardPriority(cardId, newPriority) {
        const card = document.querySelector(`[data-card-id="${cardId}"]`);
        if (card) {
            const statusCircle = card.querySelector('.status-circle');
            if (statusCircle) {
                // Обновляем класс приоритета
                statusCircle.className = `status-circle priority-${newPriority}`;
                
                // Обновляем букву приоритета
                const priorityLetter = getStatusLetter(newPriority);
                statusCircle.textContent = priorityLetter;
            }
        }
    }
    
    
    function getClientInitials(name) {
        if (!name) return 'НК';
        return name.split(' ').map(word => word[0]).join('').toUpperCase().slice(0, 2);
    }

    // Функция для управления тумблером "В пошиве"
    function toggleProductionMarker() {
        console.log('toggleProductionMarker called!');
        const toggle = document.getElementById('production-toggle');
        if (!toggle) {
            console.log('Toggle not found!');
            return;
        }
        
        console.log('Toggle clicked, activeCardId:', activeCardId);
        
        // Если есть активная карточка, обновляем только её
        if (activeCardId) {
            const activeCard = document.querySelector(`[data-card-id="${activeCardId}"]`);
            console.log('Active card found:', activeCard);
            
            if (activeCard) {
                const statusElement = activeCard.querySelector('.production-status');
                console.log('Status element found:', statusElement);
                
                if (statusElement) {
                    // Переключаем видимость
                    const isVisible = statusElement.style.display !== 'none' && statusElement.style.display !== '';
                    if (isVisible) {
                        statusElement.style.display = 'none';
                        toggle.classList.remove('active');
                        console.log('Status hidden');
                    } else {
                        statusElement.style.display = 'block';
                        toggle.classList.add('active');
                        console.log('Status shown');
                    }
                } else {
                    console.log('No status element found in active card');
                }
            } else {
                console.log('Active card not found with ID:', activeCardId);
            }
        } else {
            console.log('No active card ID');
        }
    }
    
    // Функция перехода на страницу заказа
    function goToOrderPage() {
        if (activeCardId) {
            // Открываем страницу заказа в новой вкладке
            window.open(`/orders/${activeCardId}`, '_blank');
        } else {
            alert('Не выбран активный заказ');
        }
    }

    // Функция сохранения объединенных данных контактов и доставки
    function saveUnifiedContactDelivery() {
        // Получаем все значения из полей ввода
        const clientName = document.getElementById('unified-client-name-input').value;
        const phone = document.getElementById('unified-phone-input').value;
        const email = document.getElementById('unified-email-input').value;
        const company = document.getElementById('unified-company-input').value;
        const address = document.getElementById('unified-address-input').value;
        const deliveryDate = document.getElementById('unified-delivery-date-input').value;
        const deliveryTime = document.getElementById('unified-delivery-time-input').value;
        const deliveryMethod = document.getElementById('unified-delivery-method-input').value;

        // Обновляем отображаемые значения
        document.getElementById('unified-client-name-display').textContent = clientName;
        document.getElementById('unified-phone-display').textContent = phone;
        document.getElementById('unified-email-display').textContent = email;
        document.getElementById('unified-company-display').textContent = company;
        document.getElementById('unified-address-display').textContent = address;
        document.getElementById('unified-delivery-date-display').textContent = new Date(deliveryDate).toLocaleDateString('ru-RU');
        document.getElementById('unified-delivery-time-display').textContent = deliveryTime;
        document.getElementById('unified-delivery-method-display').textContent = deliveryMethod;

        // Выходим из режима редактирования
        toggleEditMode('unified-contact-delivery');

        // Обновляем данные в основной карточке
        updateCardClientData(clientName);

        console.log('Объединенные данные контактов и доставки сохранены');
    }

    // Проверяем сохраненную тему при загрузке (перенесено в основной DOMContentLoaded)
    </script>


    <script>
    </script>

    <!-- Модальное окно настроек колонок -->
</body>
</html>