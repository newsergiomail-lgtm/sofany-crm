const express = require('express');
const Joi = require('joi');
const multer = require('multer');
const qrcode = require('qrcode-generator');
const db = require('../config/database');
const { authenticateToken, requireRole } = require('../middleware/auth');

const router = express.Router();

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞
function generateQRCode(data) {
  try {
    const qr = qrcode(0, 'M');
    qr.addData(JSON.stringify(data));
    qr.make();
    return qr.createDataURL(4);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞:', error);
    return null;
  }
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ multer –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
const storage = multer.memoryStorage();
const upload = multer({
  storage: storage,
  limits: {
    fileSize: 10 * 1024 * 1024 // 10MB
  },
  fileFilter: (req, file, cb) => {
    // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫—É –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
    if (file.originalname) {
      try {
        file.originalname = Buffer.from(file.originalname, 'latin1').toString('utf8');
      } catch (error) {
        // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–∏—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è
        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥–∏—Ä–æ–≤–∫—É –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞:', error.message);
      }
    }
    
    // –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã —Ñ–∞–π–ª–æ–≤
    const allowedTypes = /jpeg|jpg|png|gif|pdf|dwg|dxf|skp|svg|tiff|bmp/;
    const allowedMimeTypes = /image\/|application\/pdf|application\/dwg|application\/dxf|application\/x-koan/;
    const extname = allowedTypes.test(file.originalname.toLowerCase());
    const mimetype = allowedMimeTypes.test(file.mimetype);
    
    if (mimetype && extname) {
      return cb(null, true);
    } else {
      console.log('–û—Ç–∫–ª–æ–Ω–µ–Ω —Ñ–∞–π–ª:', file.originalname, '—Ç–∏–ø:', file.mimetype);
      cb(new Error('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞'));
    }
  }
});

// –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞
async function generateOrderNumber(client) {
  try {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º timestamp, —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ –∏ –ø—Ä–æ—Ü–µ—Å—Å ID –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
    const now = new Date();
    const timestamp = Math.floor(now.getTime() / 1000); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ–∫—É–Ω–¥—ã –≤–º–µ—Å—Ç–æ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥
    const random1 = Math.floor(Math.random() * 10000);
    const random2 = Math.floor(Math.random() * 1000);
    
    // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä
    const orderNumber = `SOF-${timestamp}-${random1}-${random2}`;
    
    console.log('–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:', orderNumber);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
    const existingOrder = await client.query(
      'SELECT id FROM orders WHERE order_number = $1',
      [orderNumber]
    );
    
    if (existingOrder.rows.length > 0) {
      // –ï—Å–ª–∏ –Ω–æ–º–µ—Ä —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —Å –µ—â–µ –±–æ–ª—å—à–µ–π —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å—é
      const fallbackNumber = `SOF-${Date.now()}-${Math.random().toString(36).substring(2, 15)}`;
      console.log('–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback:', fallbackNumber);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å fallback –Ω–æ–º–µ—Ä–∞
      const existingFallback = await client.query(
        'SELECT id FROM orders WHERE order_number = $1',
        [fallbackNumber]
      );
      
      if (existingFallback.rows.length > 0) {
        // –ï—Å–ª–∏ –∏ fallback —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º UUID
        const uuidNumber = `SOF-${Date.now()}-${Math.random().toString(36).substring(2, 15)}${Math.random().toString(36).substring(2, 15)}`;
        console.log('Fallback —Ç–æ–∂–µ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º UUID:', uuidNumber);
        return uuidNumber;
      }
      
      return fallbackNumber;
    }
    
    return orderNumber;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞:', error);
    // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –Ω–æ–º–µ—Ä —Å UUID
    const fallbackNumber = `SOF-${Date.now()}-${Math.random().toString(36).substring(2, 15)}`;
    console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º fallback –Ω–æ–º–µ—Ä –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏:', fallbackNumber);
    return fallbackNumber;
  }
}

// –°—Ö–µ–º—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏
const orderSchema = Joi.object({
  // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ customer_id, —Ç–∞–∫ –∏ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞
  customer_id: Joi.number().integer().optional(),
  customer_name: Joi.string().allow('').optional(),
  customer_phone: Joi.string().allow('').optional(),
  customer_email: Joi.string().email().allow('', null).optional(),
  customer_company: Joi.string().allow('').optional(),
  product_name: Joi.string().allow(''),
  status: Joi.string().valid('new', 'draft', 'confirmed', 'in_production', 'ready', 'shipped', 'delivered', 'cancelled').default('new'),
  priority: Joi.string().valid('low', 'normal', 'high', 'urgent').default('normal'),
  delivery_date: Joi.date().allow(null),
  total_amount: Joi.number().min(0).allow(null),
  prepayment_amount: Joi.number().min(0).allow(null),
  paid_amount: Joi.number().min(0).allow(null),
  notes: Joi.string().allow(''),
  // –ü–ª–æ—Å–∫–∏–µ –ø–æ–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏
  delivery_address: Joi.string().allow('', null),
  has_elevator: Joi.boolean().allow(null),
  floor: Joi.alternatives().try(Joi.number().integer(), Joi.string()).allow('', null),
  delivery_notes: Joi.string().allow('', null),
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  calculator_data: Joi.any().optional(),
  short_description: Joi.string().allow('', null),
  detailed_description: Joi.string().allow('', null),
  items: Joi.array().items(Joi.object({
    name: Joi.string().required(),
    description: Joi.string().allow(''),
    quantity: Joi.number().integer().min(1).required(),
    unit_price: Joi.number().min(0).required()
  })).min(1).required()
});

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –∫–∞–Ω–±–∞–Ω–∞ (–Ω–æ–≤—ã–µ –∏ –≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ)
router.get('/kanban', authenticateToken, async (req, res) => {
  try {
    const client = await db.pool.connect();
    
    // –ü–æ–ª—É—á–∞–µ–º –∑–∞–∫–∞–∑—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 'in_production' (—Ç–æ–ª—å–∫–æ –≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ)
    const result = await client.query(`
      SELECT 
        o.id,
        o.order_number,
        o.product_name,
        o.status,
        o.priority,
        o.total_amount,
        o.paid_amount,
        o.delivery_date,
        o.notes,
        o.created_at,
        o.updated_at,
        o.project_description,
        o.delivery_address,
        o.has_elevator,
        o.floor,
        c.name as customer_name,
        c.phone as customer_phone,
        c.email as customer_email,
        c.company as customer_company,
        COALESCE(po.production_stage, '–ö–ë') as production_stage,
        COALESCE(po.status, 'in_progress') as production_status,
        COALESCE(po.created_at, o.created_at) as stage_started_at
      FROM orders o
      LEFT JOIN customers c ON o.customer_id = c.id
      LEFT JOIN production_operations po ON o.id = po.order_id 
        AND po.status = 'in_progress' 
        AND po.operation_type = 'produce'
      WHERE o.status = 'in_production'
      ORDER BY o.priority DESC, o.created_at ASC
    `);
    
    client.release();
    
    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏ –∫–∞–Ω–±–∞–Ω–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    const columnsResult = await client.query(`
      SELECT * FROM kanban_columns 
      WHERE is_active = true 
      ORDER BY position ASC
    `);
    
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–∫–∞–∑—ã –ø–æ —ç—Ç–∞–ø–∞–º –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤–µ—Ç–æ–∫
    const kanbanData = {
      columns: columnsResult.rows.map(col => ({
        id: col.id,
        title: col.title,
        color: col.color,
        type: col.type,
        cards: []
      }))
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –≤–µ—Ç–æ–∫
    function determineBranchStatus(stage) {
      const branchStatus = {
        frame: 'not_started',
        upholstery: 'not_started'
      };
      
      switch (stage) {
        case '–ö–ë':
          branchStatus.frame = 'not_started';
          branchStatus.upholstery = 'not_started';
          break;
        case '–°—Ç–æ–ª—è—Ä–Ω—ã–π —Ü–µ—Ö':
          branchStatus.frame = 'in_progress';
          branchStatus.upholstery = 'not_started';
          break;
        case '–§–æ—Ä–º–æ–≤–∫–∞':
          branchStatus.frame = 'in_progress';
          branchStatus.upholstery = 'not_started';
          break;
        case '–®–≤–µ–π–Ω—ã–π —Ü–µ—Ö':
          branchStatus.frame = 'not_started';
          branchStatus.upholstery = 'in_progress';
          break;
        case '–û–±–∏–≤–∫–∞':
          branchStatus.frame = 'not_started';
          branchStatus.upholstery = 'in_progress';
          break;
        case '–°–±–æ—Ä–∫–∞ –∏ —É–ø–∞–∫–æ–≤–∫–∞':
          branchStatus.frame = 'completed';
          branchStatus.upholstery = 'completed';
          break;
        case '–û—Ç–≥—Ä—É–∂–µ–Ω':
          branchStatus.frame = 'completed';
          branchStatus.upholstery = 'completed';
          break;
        default:
          // –î–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ - –∑–∞–∫–∞–∑ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–µ—Ç–∫–∞—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
          if (stage.includes('–°—Ç–æ–ª—è—Ä–Ω—ã–π') || stage.includes('–§–æ—Ä–º–æ–≤–∫–∞')) {
            branchStatus.frame = 'in_progress';
          }
          if (stage.includes('–®–≤–µ–π–Ω—ã–π') || stage.includes('–û–±–∏–≤–∫–∞')) {
            branchStatus.upholstery = 'in_progress';
          }
      }
      
      return branchStatus;
    }

    // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–∞–∫–∞–∑—ã –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤–µ—Ç–æ–∫
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º Map –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤
    const processedOrders = new Map();
    
    result.rows.forEach(order => {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏ –ª–∏ –º—ã —É–∂–µ —ç—Ç–æ—Ç –∑–∞–∫–∞–∑
      if (processedOrders.has(order.id)) {
        return;
      }
      
      let stage = order.production_stage || '–ö–ë'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ö–ë —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
      let columnIndex = kanbanData.columns.findIndex(col => col.title === stage);
      
      // –ï—Å–ª–∏ —Å—Ç–∞–¥–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –∫–æ–ª–æ–Ω–∫–∞—Ö, –∏—â–µ–º –±–ª–∏–∂–∞–π—à—É—é –ø–æ–¥—Ö–æ–¥—è—â—É—é
      if (columnIndex === -1) {
        // –°–ø–∏—Å–æ–∫ —ç—Ç–∞–ø–æ–≤ –≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
        const stagePriority = ['–ö–ë', '–°—Ç–æ–ª—è—Ä–Ω—ã–π —Ü–µ—Ö', '–§–æ—Ä–º–æ–≤–∫–∞', '–®–≤–µ–π–Ω—ã–π —Ü–µ—Ö', '–û–±–∏–≤–∫–∞', '–°–±–æ—Ä–∫–∞ –∏ —É–ø–∞–∫–æ–≤–∫–∞', '–û—Ç–≥—Ä—É–∂–µ–Ω'];
        
        // –ò—â–µ–º –ø–µ—Ä–≤—É—é –ø–æ–¥—Ö–æ–¥—è—â—É—é —Å—Ç–∞–¥–∏—é
        for (const priorityStage of stagePriority) {
          const priorityIndex = kanbanData.columns.findIndex(col => col.title === priorityStage);
          if (priorityIndex !== -1) {
            stage = priorityStage;
            columnIndex = priorityIndex;
            break;
          }
        }
        
        // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é –∫–æ–ª–æ–Ω–∫—É
        if (columnIndex === -1 && kanbanData.columns.length > 0) {
          stage = kanbanData.columns[0].title;
          columnIndex = 0;
        }
      }
      
      if (columnIndex !== -1) {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤–µ—Ç–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ —ç—Ç–∞–ø–∞
        const branches = determineBranchStatus(stage);
        
        const card = {
          id: order.id,
          order_number: order.order_number,
          product_name: order.product_name,
          client: order.customer_name,
          phone: order.customer_phone,
          email: order.customer_email,
          company: order.customer_company,
          price: parseFloat(order.total_amount),
          prepayment: parseFloat(order.paid_amount),
          deadline: order.delivery_date,
          priority: order.priority,
          notes: order.notes,
          project_description: order.project_description,
          short_description: order.short_description,
          detailed_description: order.detailed_description,
          delivery_address: order.delivery_address,
          has_elevator: order.has_elevator,
          floor: order.floor,
          additional_contact: order.additional_contact,
          preferred_contact: order.preferred_contact,
          status: columnIndex + 1,
          color: order.blocked_by_materials ? "#ffebee" : "#ffffff",
          created_at: order.created_at,
          stage_started_at: order.stage_started_at,
          // –°—Ç–∞—Ç—É—Å –≤–µ—Ç–æ–∫
          branches: branches,
          // –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Å–±–æ—Ä–∫–µ
          ready_for_assembly: branches.frame === 'completed' && branches.upholstery === 'completed',
          // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
          blocked_by_materials: order.blocked_by_materials || false,
          blocked_stages: order.blocked_stages || []
        };
        
        // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        console.log(`–ó–∞–∫–∞–∑ ${order.id}: stage=${stage}, branches=${JSON.stringify(branches)}`);
        
        kanbanData.columns[columnIndex].cards.push(card);
        
        // –û—Ç–º–µ—á–∞–µ–º –∑–∞–∫–∞–∑ –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π
        processedOrders.set(order.id, true);
      }
    });
    
    res.json(kanbanData);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–∞–Ω–±–∞–Ω–∞:', error);
    res.status(500).json({ message: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
  }
});

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç—Ç–∞–ø–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –∑–∞–∫–∞–∑–∞ –≤ –∫–∞–Ω–±–∞–Ω–µ
router.put('/kanban/:orderId/stage', authenticateToken, async (req, res) => {
  try {
    const { orderId } = req.params;
    const { stage } = req.body;
    
    if (!stage) {
      return res.status(400).json({ message: '–≠—Ç–∞–ø –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –Ω–µ —É–∫–∞–∑–∞–Ω' });
    }
    
    const validStages = ['–ö–ë', '–°—Ç–æ–ª—è—Ä–Ω—ã–π —Ü–µ—Ö', '–§–æ—Ä–º–æ–≤–∫–∞', '–®–≤–µ–π–Ω—ã–π —Ü–µ—Ö', '–û–±–∏–≤–∫–∞', '–°–±–æ—Ä–∫–∞ –∏ —É–ø–∞–∫–æ–≤–∫–∞', '–û—Ç–≥—Ä—É–∂–µ–Ω'];
    if (!validStages.includes(stage)) {
      return res.status(400).json({ message: '–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —ç—Ç–∞–ø –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞' });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –¥–ª—è —ç—Ç–∞–ø–∞
    const stageMapping = {
      '–°—Ç–æ–ª—è—Ä–Ω—ã–π —Ü–µ—Ö': 'frame',
      '–®–≤–µ–π–Ω—ã–π —Ü–µ—Ö': 'upholstery', 
      '–§–æ—Ä–º–æ–≤–∫–∞': 'foam_molding',
      '–°–±–æ—Ä–∫–∞ –∏ —É–ø–∞–∫–æ–≤–∫–∞': 'assembly'
    };
    
    const mappedStage = stageMapping[stage];
    if (mappedStage) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è —ç—Ç–∞–ø–∞
      const materialsResult = await db.query(
        'SELECT * FROM check_materials_for_stage($1, $2)',
        [orderId, mappedStage]
      );
      
      const blockedMaterials = materialsResult.rows.filter(m => m.is_blocked);
      if (blockedMaterials.length > 0) {
        return res.status(400).json({
          message: `–ó–∞–∫–∞–∑ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏–∑-–∑–∞ –Ω–µ—Ö–≤–∞—Ç–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –¥–ª—è —ç—Ç–∞–ø–∞ "${stage}"`,
          blockedMaterials: blockedMaterials.map(m => ({
            material: m.material_name,
            required: m.required_quantity,
            available: m.available_quantity,
            missing: m.missing_quantity,
            unit: m.unit
          }))
        });
      }
    }
    
    const client = await db.pool.connect();
    
    await client.query('BEGIN');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –¥–ª—è –∑–∞–∫–∞–∑–∞
    const existingOperation = await client.query(`
      SELECT id FROM production_operations 
      WHERE order_id = $1 AND status = 'in_progress' AND operation_type = 'produce'
    `, [orderId]);
    
    if (existingOperation.rows.length > 0) {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –æ–ø–µ—Ä–∞—Ü–∏—é
      await client.query(`
        UPDATE production_operations 
        SET production_stage = $1, updated_at = CURRENT_TIMESTAMP
        WHERE order_id = $2 AND status = 'in_progress' AND operation_type = 'produce'
      `, [stage, orderId]);
    } else {
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –æ–ø–µ—Ä–∞—Ü–∏—é –¥–ª—è –∑–∞–∫–∞–∑–∞
      await client.query(`
        INSERT INTO production_operations (order_id, operation_type, production_stage, status, created_by)
        VALUES ($1, 'produce', $2, 'in_progress', $3)
      `, [orderId, stage, req.user.id]);
    }
    
    // –ï—Å–ª–∏ –∑–∞–∫–∞–∑ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ "–û—Ç–≥—Ä—É–∂–µ–Ω", –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
    if (stage === '–û—Ç–≥—Ä—É–∂–µ–Ω') {
      await client.query(`
        UPDATE orders 
        SET status = 'shipped', updated_at = CURRENT_TIMESTAMP
        WHERE id = $1
      `, [orderId]);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é —Å—Ç–∞—Ç—É—Å–æ–≤
      await client.query(`
        INSERT INTO order_status_history (order_id, status, comment, created_by)
        VALUES ($1, $2, $3, $4)
      `, [orderId, 'shipped', `–ó–∞–∫–∞–∑ –æ—Ç–≥—Ä—É–∂–µ–Ω`, req.user.id]);
    }
    
    await client.query('COMMIT');
    client.release();
    
    res.json({ message: '–≠—Ç–∞–ø –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –æ–±–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ' });
  } catch (error) {
    await client.query('ROLLBACK');
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —ç—Ç–∞–ø–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞:', error);
    res.status(500).json({ message: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
  }
});

// –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
router.get('/', authenticateToken, async (req, res) => {
  try {
    const { 
      page = 1, 
      limit = 20, 
      status, 
      customer_id, 
      priority,
      search,
      sort_by = 'created_at',
      sort_order = 'desc'
    } = req.query;

    const offset = (page - 1) * limit;
    let whereConditions = [];
    let queryParams = [];
    let paramCount = 0;

    // –í—Å–µ–≥–¥–∞ –∏—Å–∫–ª—é—á–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã (—Å—Ç–∞—Ç—É—Å 'cancelled')
    whereConditions.push(`o.status != 'cancelled'`);

    // –§–∏–ª—å—Ç—Ä—ã
    if (status) {
      paramCount++;
      whereConditions.push(`o.status = $${paramCount}`);
      queryParams.push(status);
    }

    if (customer_id) {
      paramCount++;
      whereConditions.push(`o.customer_id = $${paramCount}`);
      queryParams.push(customer_id);
    }

    if (priority) {
      paramCount++;
      whereConditions.push(`o.priority = $${paramCount}`);
      queryParams.push(priority);
    }

    if (search) {
      paramCount++;
      whereConditions.push(`(o.order_number ILIKE $${paramCount} OR c.name ILIKE $${paramCount})`);
      queryParams.push(`%${search}%`);
    }

    const whereClause = whereConditions.length > 0 ? `WHERE ${whereConditions.join(' AND ')}` : '';

    // –ü–æ–¥—Å—á–µ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    const countQuery = `
      SELECT COUNT(*) as total
      FROM orders o
      LEFT JOIN customers c ON o.customer_id = c.id
      ${whereClause}
    `;
    const countResult = await db.query(countQuery, queryParams);
    const total = parseInt(countResult.rows[0].total);

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤
    paramCount++;
    const ordersQuery = `
      SELECT 
        o.*,
        c.name as customer_name,
        c.email as customer_email,
        c.phone as customer_phone,
        u.name as created_by_name,
        (SELECT COUNT(*) FROM order_items WHERE order_id = o.id) as items_count,
        CASE 
          WHEN o.source = 'calc' THEN 'calc'
          ELSE 'crm'
        END as order_source
      FROM orders o
      LEFT JOIN customers c ON o.customer_id = c.id
      LEFT JOIN users u ON o.created_by = u.id
      ${whereClause}
      ORDER BY o.${sort_by} ${sort_order.toUpperCase()}
      LIMIT $${paramCount} OFFSET $${paramCount + 1}
    `;
    queryParams.push(limit, offset);

    const ordersResult = await db.query(ordersQuery, queryParams);

    res.json({
      orders: ordersResult.rows,
      pagination: {
        page: parseInt(page),
        limit: parseInt(limit),
        total,
        pages: Math.ceil(total / limit)
      }
    });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤:', error);
    res.status(500).json({ message: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
  }
});

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –ø–æ ID –∏–ª–∏ order_number
router.get('/:id', authenticateToken, async (req, res) => {
  try {
    const { id } = req.params;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ id —á–∏—Å–ª–æ–º –∏–ª–∏ —Å—Ç—Ä–æ–∫–æ–π (order_number)
    const isNumericId = /^\d+$/.test(id);
    
    // –ü–æ–ª—É—á–∞–µ–º –∑–∞–∫–∞–∑
    let orderResult;
    if (isNumericId) {
      orderResult = await db.query(`
        SELECT 
          o.*,
          c.name as customer_name,
          c.email as customer_email,
          c.phone as customer_phone,
          c.company as customer_company,
          c.address as customer_address,
          u.name as created_by_name
        FROM orders o
        LEFT JOIN customers c ON o.customer_id = c.id
        LEFT JOIN users u ON o.created_by = u.id
        WHERE o.id = $1
      `, [id]);
    } else {
      orderResult = await db.query(`
        SELECT 
          o.*,
          c.name as customer_name,
          c.email as customer_email,
          c.phone as customer_phone,
          c.company as customer_company,
          c.address as customer_address,
          u.name as created_by_name
        FROM orders o
        LEFT JOIN customers c ON o.customer_id = c.id
        LEFT JOIN users u ON o.created_by = u.id
        WHERE o.order_number = $1
      `, [id]);
    }

    if (orderResult.rows.length === 0) {
      return res.status(404).json({ message: '–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω' });
    }

    const order = orderResult.rows[0];

    // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞
    const itemsResult = await db.query(`
      SELECT * FROM order_items WHERE order_id = $1 ORDER BY id
    `, [id]);

    // –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å—Ç–∞—Ç—É—Å–æ–≤
    const statusHistoryResult = await db.query(`
      SELECT 
        osh.*,
        u.name as created_by_name
      FROM order_status_history osh
      LEFT JOIN users u ON osh.created_by = u.id
      WHERE osh.order_id = $1
      ORDER BY osh.created_at DESC
    `, [id]);

    order.items = itemsResult.rows;
    order.status_history = statusHistoryResult.rows;

    res.json({ order });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞:', error);
    res.status(500).json({ message: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
  }
});

// –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞
router.post('/', authenticateToken, async (req, res) => {
  console.log('üîÑ POST /api/orders - —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ - –ù–ê–ß–ê–õ–û');
  console.log('üìã –î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞:', req.body);
  console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', req.user);
  
  const client = await db.pool.connect();
  let finalCustomerId = null; // –û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤ –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏
  
  // –û–±—ä—è–≤–ª—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏
  let product_name, status, priority, delivery_date, notes, items, total_amount, prepayment_amount, paid_amount;
  let customer_id, customer_name, customer_phone, customer_email, customer_company;
  let order = null; // –û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é order –≤ –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏
  
  try {
    await client.query('BEGIN');

    const { error, value } = orderSchema.validate(req.body);
    if (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:', error.details[0].message);
      return res.status(400).json({ message: error.details[0].message });
    }
    
    console.log('‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ');

    // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞
    customer_id = value.customer_id;
    customer_name = value.customer_name;
    customer_phone = value.customer_phone;
    customer_email = value.customer_email;
    customer_company = value.customer_company;

    const { 
      delivery_address, has_elevator, floor, delivery_notes,
      calculator_data
    } = value;

    // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º
    product_name = value.product_name;
    status = value.status;
    priority = value.priority;
    delivery_date = value.delivery_date;
    notes = value.notes;
    items = value.items;
    total_amount = value.total_amount;
    prepayment_amount = value.prepayment_amount;
    paid_amount = value.paid_amount;

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞ - —Å–æ–∑–¥–∞–µ–º –∏–ª–∏ –Ω–∞—Ö–æ–¥–∏–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ
    finalCustomerId = null;
    console.log('üîç –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞:', { customer_id, customer_name, customer_phone, customer_email });
    
    // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω customer_id, –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ–≥–æ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ
    if (customer_id) {
      const existingCustomer = await client.query('SELECT id FROM customers WHERE id = $1', [customer_id]);
      if (existingCustomer.rows.length > 0) {
        finalCustomerId = customer_id;
        console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞, ID:', finalCustomerId);
      } else {
        console.log('‚ùå –ö–ª–∏–µ–Ω—Ç —Å ID', customer_id, '–Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
      }
    }
    
    // –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—â–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ
    if (!finalCustomerId) {
      console.log('üîç –ò—â–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞...');
      
      // –ò—â–µ–º –ø–æ email
      if (customer_email && customer_email.trim()) {
        const existingByEmail = await client.query(
          'SELECT id FROM customers WHERE email = $1',
          [customer_email.trim()]
        );
        if (existingByEmail.rows.length > 0) {
          finalCustomerId = existingByEmail.rows[0].id;
          console.log('‚úÖ –ù–∞–π–¥–µ–Ω –∫–ª–∏–µ–Ω—Ç –ø–æ email, ID:', finalCustomerId);
        }
      }
      
      // –ò—â–µ–º –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
      if (!finalCustomerId && customer_phone && customer_phone.trim()) {
        const existingByPhone = await client.query(
          'SELECT id FROM customers WHERE phone = $1',
          [customer_phone.trim()]
        );
        if (existingByPhone.rows.length > 0) {
          finalCustomerId = existingByPhone.rows[0].id;
          console.log('‚úÖ –ù–∞–π–¥–µ–Ω –∫–ª–∏–µ–Ω—Ç –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É, ID:', finalCustomerId);
        }
      }
      
      // –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ
      if (!finalCustomerId && customer_name) {
        console.log('üîç –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞...');
        const newCustomer = await client.query(`
          INSERT INTO customers (name, email, phone, company, status, created_by)
          VALUES ($1, $2, $3, $4, 'active', $5)
          RETURNING id
        `, [
          customer_name || '–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç',
          customer_email && customer_email.trim() ? customer_email.trim() : null,
          customer_phone && customer_phone.trim() ? customer_phone.trim() : null,
          customer_company || null,
          req.user?.id || 1
        ]);
        finalCustomerId = newCustomer.rows[0].id;
        console.log('‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç, ID:', finalCustomerId);
      }
    }
    
    console.log('üîç –§–∏–Ω–∞–ª—å–Ω—ã–π ID –∫–ª–∏–µ–Ω—Ç–∞:', finalCustomerId);
    if (!finalCustomerId) {
      return res.status(400).json({ message: '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞' });
    }
    
    console.log('üë§ –û–±—Ä–∞–±–æ—Ç–∞–Ω –∫–ª–∏–µ–Ω—Ç, ID:', finalCustomerId);

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
    const orderNumber = await generateOrderNumber(client);

    // –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑
    const orderResult = await client.query(`
      INSERT INTO orders (
        order_number, customer_id, product_name, status, priority, notes, created_by,
        total_amount, paid_amount
      )
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
      RETURNING *
    `, [
      orderNumber, finalCustomerId, product_name || '', status, priority, notes || '', parseInt(req.user?.id || 1),
      parseFloat(total_amount) || 0, parseFloat(prepayment_amount || paid_amount) || 0
    ]);

    const order = orderResult.rows[0];
    console.log('‚úÖ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω, ID:', order.id);

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞
    let totalAmount = 0;
    console.log('üîç –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:', items.length);
    for (const item of items) {
      const totalPrice = item.quantity * item.unit_price;
      totalAmount += totalPrice;
      console.log('üîç –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é:', item.name, '—Ü–µ–Ω–∞:', totalPrice);

      await client.query(`
        INSERT INTO order_items (order_id, name, description, quantity, unit_price, total_price)
        VALUES ($1, $2, $3, $4, $5, $6)
      `, [order.id, item.name, item.description || '', item.quantity, item.unit_price, totalPrice]);
    }
    console.log('‚úÖ –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞ –¥–æ–±–∞–≤–ª–µ–Ω—ã, –æ–±—â–∞—è —Å—É–º–º–∞:', totalAmount);

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—É–º–º—É –∑–∞–∫–∞–∑–∞
    await client.query(`
      UPDATE orders SET total_amount = $1 WHERE id = $2
    `, [totalAmount, order.id]);

    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é —Å—Ç–∞—Ç—É—Å–æ–≤ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è
    console.log('‚úÖ –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –∑–∞–∫–∞–∑–∞ ID:', order.id);

    // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é QR-–∫–æ–¥–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    console.log('üîç –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é QR-–∫–æ–¥–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏');

    console.log('üîç –ö–æ–º–º–∏—Ç–∏–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é...');
    await client.query('COMMIT');
    console.log('‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω–∞');

    console.log('üîç –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç...');
    res.status(201).json({
      message: '–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω',
      order: { ...order, total_amount: totalAmount }
    });
    console.log('‚úÖ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
  } catch (error) {
    await client.query('ROLLBACK');
    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞:', error);
    
    // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    if (error.code === '23505') {
      console.log('–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π');
      const newOrderNumber = `SOF-${Date.now()}-${Math.random().toString(36).substring(2, 8)}`;
      
      try {
        await client.query('BEGIN');
        
        // –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑ —Å –Ω–æ–≤—ã–º –Ω–æ–º–µ—Ä–æ–º
        const orderResult = await client.query(`
          INSERT INTO orders (
            order_number, customer_id, product_name, status, priority, notes, created_by,
            total_amount, paid_amount
          )
          VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
          RETURNING *
        `, [
          newOrderNumber, finalCustomerId, product_name || '', status, priority, notes || '', parseInt(req.user?.id || 1),
          parseFloat(total_amount) || 0, parseFloat(prepayment_amount || paid_amount) || 0
        ]);

        const order = orderResult.rows[0];

        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞
        let totalAmount = 0;
        for (const item of items) {
          const totalPrice = item.quantity * item.unit_price;
          totalAmount += totalPrice;

          await client.query(`
            INSERT INTO order_items (order_id, name, description, quantity, unit_price, total_price)
            VALUES ($1, $2, $3, $4, $5, $6)
          `, [order.id, item.name, item.description, item.quantity, item.unit_price, totalPrice]);
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—É–º–º—É –∑–∞–∫–∞–∑–∞
        await client.query(`
          UPDATE orders SET total_amount = $1 WHERE id = $2
        `, [totalAmount, order.id]);

        await client.query('COMMIT');

        return res.status(201).json({
          message: '–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω —Å –Ω–æ–≤—ã–º –Ω–æ–º–µ—Ä–æ–º',
          order: order,
          warning: '–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –±—ã–ª –∏–∑–º–µ–Ω–µ–Ω –∏–∑-–∑–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è'
        });
        
      } catch (retryError) {
        await client.query('ROLLBACK');
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ —Å –Ω–æ–≤—ã–º –Ω–æ–º–µ—Ä–æ–º:', retryError);
        return res.status(500).json({ 
          message: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑',
          error: 'CREATE_FAILED',
          details: retryError.message
        });
      }
    } // –ö–æ–Ω–µ—Ü –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
  } finally {
    client.release();
  }
});

// GET /api/orders/:id - –ø–æ–ª—É—á–∏—Ç—å –∑–∞–∫–∞–∑ –ø–æ ID
      try {
        await client.query('BEGIN');
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä
        const fallbackNumber = `SOF-${Date.now()}-${Math.random().toString(36).substring(2, 15)}`;
        console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º fallback –Ω–æ–º–µ—Ä:', fallbackNumber);
        console.log('üë§ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª–∏–µ–Ω—Ç–∞ ID:', finalCustomerId);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ retry –ª–æ–≥–∏–∫–µ
        const customerCheck = await client.query('SELECT id FROM customers WHERE id = $1', [finalCustomerId]);
        if (customerCheck.rows.length === 0) {
          console.log('‚ùå –í retry: –∫–ª–∏–µ–Ω—Ç —Å ID', finalCustomerId, '–Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ');
          const newCustomer = await client.query(`
            INSERT INTO customers (name, email, phone, company, status, created_by)
            VALUES ($1, $2, $3, $4, 'active', $5)
            RETURNING id
          `, [
            customer_name || '–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç',
            customer_email && customer_email.trim() ? customer_email.trim() : null,
            customer_phone && customer_phone.trim() ? customer_phone.trim() : null,
            customer_company || null,
            req.user?.id || 1
          ]);
          finalCustomerId = newCustomer.rows[0].id;
          console.log('‚úÖ –í retry: —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç, ID:', finalCustomerId);
        }
        
        // –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑ —Å –Ω–æ–≤—ã–º –Ω–æ–º–µ—Ä–æ–º
        const orderResult = await client.query(`
          INSERT INTO orders (
            order_number, customer_id, product_name, status, priority, notes, created_by,
            total_amount, paid_amount
          )
          VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
          RETURNING *
        `, [
          fallbackNumber, finalCustomerId, product_name || '', status, priority, notes || '', parseInt(req.user?.id || 1),
          parseFloat(total_amount) || 0, parseFloat(prepayment_amount || paid_amount) || 0
        ]);

        order = orderResult.rows[0];

        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞
        let totalAmount = 0;
        for (const item of items) {
          const totalPrice = item.quantity * item.unit_price;
          totalAmount += totalPrice;

          await client.query(`
            INSERT INTO order_items (order_id, name, description, quantity, unit_price, total_price)
            VALUES ($1, $2, $3, $4, $5, $6)
          `, [order.id, item.name, item.description, item.quantity, item.unit_price, totalPrice]);
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—É–º–º—É –∑–∞–∫–∞–∑–∞
        await client.query(`
          UPDATE orders SET total_amount = $1 WHERE id = $2
        `, [totalAmount, order.id]);

        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é —Å—Ç–∞—Ç—É—Å–æ–≤ (–ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–ø–∏—Å—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
        console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –∑–∞–∫–∞–∑–∞ ID:', order.id, '—Å—Ç–∞—Ç—É—Å:', status);
        // –í retry –ª–æ–≥–∏–∫–µ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–µ
        console.log('‚úÖ –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è retry –∑–∞–∫–∞–∑–∞ ID:', order.id);

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR –∫–æ–¥
        const qrData = {
          order_id: order.id,
          order_number: order.order_number,
          timestamp: Math.floor(Date.now() / 1000)
        };

        const qrCodeData = JSON.stringify(qrData);
        const expiresAt = new Date(Date.now() + (30 * 24 * 60 * 60 * 1000)); // 30 –¥–Ω–µ–π

        const qrResult = await client.query(`
          INSERT INTO order_qr_codes (order_id, qr_code, expires_at)
          VALUES ($1, $2, $3)
          RETURNING id
        `, [order.id, qrCodeData, expiresAt]);

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–∫–∞–∑ —Å ID QR –∫–æ–¥–∞
        await client.query(`
          UPDATE orders SET qr_code_id = $1 WHERE id = $2
        `, [qrResult.rows[0].id, order.id]);

        await client.query('COMMIT');

        return res.status(201).json({
          message: '–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω —Å –Ω–æ–≤—ã–º –Ω–æ–º–µ—Ä–æ–º',
          order: { ...order, qr_code_id: qrResult.rows[0].id },
          warning: '–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –±—ã–ª –∏–∑–º–µ–Ω–µ–Ω –∏–∑-–∑–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è'
        });
        
      } catch (retryError) {
        await client.query('ROLLBACK');
        console.error('–û—à–∏–±–∫–∞ retry —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞:', retryError);
        console.error('–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', retryError.message);
        console.error('–ö–æ–¥ –æ—à–∏–±–∫–∏:', retryError.code);
        return res.status(500).json({ 
          message: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ –¥–∞–∂–µ —Å –Ω–æ–≤—ã–º –Ω–æ–º–µ—Ä–æ–º',
          error: 'RETRY_FAILED',
          details: retryError.message
        });
      }
    } else if (error.code === '23503') {
      res.status(400).json({ 
        message: '–£–∫–∞–∑–∞–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω',
        error: 'CUSTOMER_NOT_FOUND'
      });
    } else {
      res.status(500).json({ 
        message: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞',
        error: error.message
      });
    }
  } finally {
    client.release();
  }
});

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ (–ø—Ä–æ—Å—Ç–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç)
router.put('/:id/status', authenticateToken, async (req, res) => {
  const client = await db.pool.connect();
  
  try {
    const { id } = req.params;
    const { status } = req.body;

    if (!status) {
      return res.status(400).json({ message: '–°—Ç–∞—Ç—É—Å –Ω–µ —É–∫–∞–∑–∞–Ω' });
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
    const existingOrder = await client.query('SELECT * FROM orders WHERE id = $1', [id]);
    if (existingOrder.rows.length === 0) {
      return res.status(404).json({ message: '–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω' });
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å
    const result = await client.query(`
      UPDATE orders 
      SET status = $1, updated_at = CURRENT_TIMESTAMP
      WHERE id = $2
      RETURNING *
    `, [status, id]);

    // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ "in_production", —Å–æ–∑–¥–∞–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞
    if (status === 'in_production') {
      try {
        await client.query(`
          INSERT INTO production_operations (
            order_id, operation_type, production_stage, status
          )
          VALUES ($1, $2, $3, $4)
        `, [id, 'produce', '–ö–ë', 'in_progress']);
      } catch (productionError) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞:', productionError);
        // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, —Ç–∞–∫ –∫–∞–∫ —Å—Ç–∞—Ç—É—Å —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω
      }
    }

    res.json({
      message: '–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω',
      order: result.rows[0]
    });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞:', error);
    res.status(500).json({ message: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
  } finally {
    client.release();
  }
});

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
router.put('/:id', authenticateToken, async (req, res) => {
  const client = await db.pool.connect();
  
  try {
    await client.query('BEGIN');
    
    const { id } = req.params;
    const { 
      status, 
      priority, 
      delivery_date, 
      notes, 
      paid_amount,
      total_amount,
      prepayment_amount,
      delivery_address,
      has_elevator,
      floor,
      delivery_notes,
      project_description,
      calculator_data,
      items
    } = req.body;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
    const existingOrder = await client.query('SELECT * FROM orders WHERE id = $1', [id]);
    if (existingOrder.rows.length === 0) {
      return res.status(404).json({ message: '–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω' });
    }

    const currentOrder = existingOrder.rows[0];

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞:', {
      id,
      status,
      priority,
      delivery_date,
      total_amount,
      prepayment_amount
    });
    console.log('üìã –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞:', req.body);

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —Å –ø—Ä–æ—Å—Ç—ã–º SQL –∑–∞–ø—Ä–æ—Å–æ–º
    const result = await client.query(`
      UPDATE orders 
      SET 
        status = COALESCE($1, orders.status),
        priority = COALESCE($2, orders.priority),
        delivery_date = COALESCE($3, orders.delivery_date),
        notes = COALESCE($4, orders.notes),
        paid_amount = COALESCE($5, orders.paid_amount),
        total_amount = COALESCE($6, orders.total_amount),
        delivery_address = COALESCE($7, orders.delivery_address),
        has_elevator = COALESCE($8, orders.has_elevator),
        floor = COALESCE($9, orders.floor),
        delivery_notes = COALESCE($10, orders.delivery_notes),
      project_description = COALESCE($11, orders.project_description),
        calculator_data = COALESCE($12, orders.calculator_data),
      updated_at = CURRENT_TIMESTAMP
      WHERE id = $13
      RETURNING *
    `, [
      status || null, 
      priority || null, 
      delivery_date || null, 
      notes || null, 
      paid_amount || null,
      total_amount || null,
      delivery_address || null,
      has_elevator !== undefined ? has_elevator : null,
      floor || null,
      delivery_notes || null,
      project_description || null,
      calculator_data ? JSON.stringify(calculator_data) : null,
      id
    ]);

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞ –µ—Å–ª–∏ –æ–Ω–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã
    if (items && Array.isArray(items)) {
      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø–æ–∑–∏—Ü–∏–∏
      await client.query('DELETE FROM order_items WHERE order_id = $1', [id]);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏
      for (const item of items) {
        await client.query(`
          INSERT INTO order_items (order_id, name, description, quantity, unit_price, total_price)
          VALUES ($1, $2, $3, $4, $5, $6)
        `, [
          id,
          item.name,
          item.description || '',
          item.quantity || 1,
          item.unit_price || 0,
          (item.quantity || 1) * (item.unit_price || 0)
        ]);
      }
    }

    // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è, –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
    if (status && status !== currentOrder.status) {
      await client.query(`
        INSERT INTO order_status_history (order_id, status, comment, created_by)
        VALUES ($1, $2, $3, $4)
      `, [id, status, '–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω', req.user.id]);
    }

    await client.query('COMMIT');

    res.json({
      message: '–ó–∞–∫–∞–∑ –æ–±–Ω–æ–≤–ª–µ–Ω',
      order: result.rows[0]
    });
  } catch (error) {
    await client.query('ROLLBACK');
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞:', error);
    res.status(500).json({ message: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
  } finally {
    client.release();
  }
});

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞
router.put('/:id/customer', authenticateToken, async (req, res) => {
  try {
    const { id } = req.params;
    const { name, phone, email, company } = req.body;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
    const existingOrder = await db.query('SELECT * FROM orders WHERE id = $1', [id]);
    if (existingOrder.rows.length === 0) {
      return res.status(404).json({ message: '–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω' });
    }

    const order = existingOrder.rows[0];

    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
    const result = await db.query(`
      UPDATE customers 
      SET 
        name = COALESCE($1, name),
        phone = COALESCE($2, phone),
        email = COALESCE($3, email),
        company = COALESCE($4, company),
        updated_at = CURRENT_TIMESTAMP
      WHERE id = $5
      RETURNING *
    `, [name, phone, email, company, order.customer_id]);

    res.json({ message: '–î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', customer: result.rows[0] });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞:', error);
    res.status(500).json({ message: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
  }
});

// –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (–º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ - –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω—ã–π)
router.delete('/:id', authenticateToken, requireRole(['admin']), async (req, res) => {
  try {
    const { id } = req.params;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∑–∞–∫–∞–∑
    const orderCheck = await db.query('SELECT id, status FROM orders WHERE id = $1', [id]);
    if (orderCheck.rows.length === 0) {
      return res.status(404).json({ message: '–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω' });
    }

    // –ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ - –ø–æ–º–µ—á–∞–µ–º –∑–∞–∫–∞–∑ –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω—ã–π
    const result = await db.query(
      'UPDATE orders SET status = $1, notes = COALESCE(notes, \'\') || \' [–£–î–ê–õ–ï–ù]\' WHERE id = $2 RETURNING *', 
      ['cancelled', id]
    );

    res.json({ message: '–ó–∞–∫–∞–∑ —É–¥–∞–ª–µ–Ω' });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞:', error);
    res.status(500).json({ message: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
  }
});

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞–∫–∞–∑–æ–≤
router.get('/stats/overview', authenticateToken, async (req, res) => {
  try {
    const { period = '30' } = req.query; // –¥–Ω–µ–π

    const statsResult = await db.query(`
      SELECT 
        COUNT(*) as total_orders,
        COUNT(CASE WHEN status = 'new' THEN 1 END) as new_orders,
        COUNT(CASE WHEN status = 'in_production' AND (production_status = 'in_progress' OR production_status IS NULL) THEN 1 END) as in_production,
        COUNT(CASE WHEN status = 'in_sewing' THEN 1 END) as in_sewing,
        COUNT(CASE WHEN status = 'ready' THEN 1 END) as ready,
        COUNT(CASE WHEN status = 'delivered' THEN 1 END) as delivered,
        COUNT(CASE WHEN priority = 'high' OR priority = 'urgent' THEN 1 END) as urgent_orders,
        COALESCE(SUM(total_amount), 0) as total_revenue,
        COALESCE(SUM(paid_amount), 0) as total_paid,
        COALESCE(AVG(total_amount), 0) as avg_order_value
      FROM orders 
      WHERE created_at >= CURRENT_DATE - INTERVAL '${period} days'
    `);

    res.json({ stats: statsResult.rows[0] });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
    res.status(500).json({ message: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
  }
});

// Endpoints –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–µ—Ä—Ç–µ–∂–∞–º–∏

// GET /api/orders/:id/drawings - –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —á–µ—Ä—Ç–µ–∂–µ–π –∑–∞–∫–∞–∑–∞
router.get('/:id/drawings', authenticateToken, async (req, res) => {
  try {
    const { id } = req.params;
    
    const result = await db.query(
      'SELECT id, file_name, file_type, file_size, created_at FROM order_drawings WHERE order_id = $1 ORDER BY created_at DESC',
      [id]
    );
    
    res.json({ files: result.rows });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —á–µ—Ä—Ç–µ–∂–µ–π:', error);
    res.status(500).json({ message: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
  }
});

// POST /api/orders/:id/drawings - –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–µ—Ä—Ç–µ–∂
router.post('/:id/drawings', authenticateToken, upload.single('drawing'), async (req, res) => {
  try {
    const { id } = req.params;
    const file = req.file;
    
    if (!file) {
      return res.status(400).json({ message: '–§–∞–π–ª –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω' });
    }
    
    // –ò–º—è —Ñ–∞–π–ª–∞ —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ fileFilter
    const fileName = file.originalname;
    
    const result = await db.query(
      'INSERT INTO order_drawings (order_id, file_name, file_data, file_type, file_size, uploaded_by) VALUES ($1, $2, $3, $4, $5, $6) RETURNING id',
      [id, fileName, file.buffer, file.mimetype, file.size, req.user.id]
    );
    
    res.json({ 
      message: '–ß–µ—Ä—Ç–µ–∂ –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ',
      drawing: {
        id: result.rows[0].id,
        file_name: fileName,
        file_type: file.mimetype,
        file_size: file.size
      }
    });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä—Ç–µ–∂–∞:', error);
    res.status(500).json({ message: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
  }
});

// GET /api/orders/:id/drawings/:drawingId - –ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä—Ç–µ–∂
router.get('/:id/drawings/:drawingId', authenticateToken, async (req, res) => {
  try {
    const { id, drawingId } = req.params;
    
    const result = await db.query(
      'SELECT file_name, file_data, file_type FROM order_drawings WHERE id = $1 AND order_id = $2',
      [drawingId, id]
    );
    
    if (result.rows.length === 0) {
      return res.status(404).json({ message: '–ß–µ—Ä—Ç–µ–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω' });
    }
    
    const drawing = result.rows[0];
    
    res.set({
      'Content-Type': drawing.file_type,
      'Content-Disposition': `attachment; filename="${drawing.file_name}"`,
      'Content-Length': drawing.file_data.length
    });
    
    res.send(drawing.file_data);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —á–µ—Ä—Ç–µ–∂–∞:', error);
    res.status(500).json({ message: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
  }
});

// DELETE /api/orders/:id/drawings/:drawingId - —É–¥–∞–ª–∏—Ç—å —á–µ—Ä—Ç–µ–∂
router.delete('/:id/drawings/:drawingId', authenticateToken, async (req, res) => {
  try {
    const { id, drawingId } = req.params;
    
    const result = await db.query(
      'DELETE FROM order_drawings WHERE id = $1 AND order_id = $2 RETURNING file_name',
      [drawingId, id]
    );
    
    if (result.rows.length === 0) {
      return res.status(404).json({ message: '–ß–µ—Ä—Ç–µ–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω' });
    }
    
    res.json({ message: '–ß–µ—Ä—Ç–µ–∂ —É–¥–∞–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ' });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–µ—Ä—Ç–µ–∂–∞:', error);
    res.status(500).json({ message: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
  }
});

module.exports = router;






// GET /api/orders/:id/drawings/:drawingId - –ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä—Ç–µ–∂
router.get('/:id/drawings/:drawingId', authenticateToken, async (req, res) => {
  try {
    const { id, drawingId } = req.params;
    
    const result = await db.query(
      'SELECT file_name, file_data, file_type FROM order_drawings WHERE id = $1 AND order_id = $2',
      [drawingId, id]
    );
    
    if (result.rows.length === 0) {
      return res.status(404).json({ message: '–ß–µ—Ä—Ç–µ–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω' });
    }
    
    const drawing = result.rows[0];
    
    res.set({
      'Content-Type': drawing.file_type,
      'Content-Disposition': `attachment; filename="${drawing.file_name}"`,
      'Content-Length': drawing.file_data.length
    });
    
    res.send(drawing.file_data);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —á–µ—Ä—Ç–µ–∂–∞:', error);
    res.status(500).json({ message: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
  }
});

// DELETE /api/orders/:id/drawings/:drawingId - —É–¥–∞–ª–∏—Ç—å —á–µ—Ä—Ç–µ–∂
router.delete('/:id/drawings/:drawingId', authenticateToken, async (req, res) => {
  try {
    const { id, drawingId } = req.params;
    
    const result = await db.query(
      'DELETE FROM order_drawings WHERE id = $1 AND order_id = $2 RETURNING file_name',
      [drawingId, id]
    );
    
    if (result.rows.length === 0) {
      return res.status(404).json({ message: '–ß–µ—Ä—Ç–µ–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω' });
    }
    
    res.json({ message: '–ß–µ—Ä—Ç–µ–∂ —É–¥–∞–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ' });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–µ—Ä—Ç–µ–∂–∞:', error);
    res.status(500).json({ message: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
  }
});

module.exports = router;

